
<div style="visibility: hidden; position: fixed"
     [style.left]="menuTopLeftPosition.x"
     [style.top]="menuTopLeftPosition.y"
     [matMenuTriggerFor]="rightMenu">
</div>

<mat-menu #rightMenu="matMenu">
  <div>
    <ng-template matMenuContent>
      <div *ngIf="rightclicked_item.type">
        <div *ngIf="rightclicked_item.type === 'user_play'">
          <button mat-menu-item (click)="tapSelected()">Toggle Tap</button>
          <button mat-menu-item (click)="rightclicked_item.card.locked=!rightclicked_item.card.locked">(Un)Lock Tap</button>
          <button mat-menu-item (click)="shakeCard(rightclicked_item.card, user.id, 'play')">Shake</button>
          <button mat-menu-item (click)="cloneCard(rightclicked_item.card)">Clone</button>
          <button mat-menu-item [matMenuTriggerFor]="counters">Counters</button>
          <button mat-menu-item [matMenuTriggerFor]="token_menu" *ngIf="rightclicked_item && rightclicked_item.card && rightclicked_item.card.tokens && rightclicked_item.card.tokens.length> 0">Tokens</button>
          <button mat-menu-item [matMenuTriggerFor]="orient">Orient</button>
          <button mat-menu-item [matMenuTriggerFor]="sendTo">Send To</button>
          <button mat-menu-item [matMenuTriggerFor]="revealTo">Reveal To</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'opponent_play'">
          <button mat-menu-item (click)="shakeCard(rightclicked_item.card, rightclicked_item.userid, 'play')">Shake</button>
          <button mat-menu-item (click)="cloneCard(rightclicked_item.card)">Clone</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'user_playmat'">
          <button mat-menu-item (click)="untapAll()">Untap All</button>
          <button mat-menu-item (click)="openTokenDialog()">Insert Token</button>
          <mat-form-field appearance="standard" style="margin: 0 15px 0 15px; width: 125px">
            <mat-label>Quick Insert Token</mat-label>
            <input #quick_token type="text" matInput (click)="$event.stopPropagation()">
            <button matSuffix mat-icon-button aria-label="Draw" (click)="createToken({name: quick_token.value})"><mat-icon>add</mat-icon></button>
          </mat-form-field>
          <button mat-menu-item [matMenuTriggerFor]="play_counter">Insert Counter</button>
          <button *ngIf="user != null && game_data != null && user.turn == game_data.current_turn" mat-menu-item (click)="endTurn()">End Turn</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'type_counter'">
          <button mat-menu-item (click)="deleteCounter(rightclicked_item.counter)">Delete</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'opponent_playmat'">
          <button mat-menu-item>Taunt</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'commander'">
          <button mat-menu-item (click)="openDeckSelectDialog()">Change Deck</button>
          <button mat-menu-item (click)="scoopDeck()">Scoop Deck</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'user_hand'">
          <button mat-menu-item [matMenuTriggerFor]="sendTo">Send To</button>
          <button mat-menu-item
                  (click)="rightclicked_item.card.facedown=true;
                rightclicked_item.card.visible=[];
                clearSelection();
                selectCard(rightclicked_item.card, rightclicked_item.from);
                sendCardToZone(rightclicked_item.card, rightclicked_item.from, 'play')">
            Send to Play Face Down
          </button>
          <button *ngIf="rightclicked_item.card.back_face" mat-menu-item (click)="altFaceCard(rightclicked_item.card)">Alt Face</button>
          <button mat-menu-item (click)="shakeCard(rightclicked_item.card, user.id, 'hand')">Shake</button>
          <button mat-menu-item [matMenuTriggerFor]="revealTo">Reveal To</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'opponent_hand'">
          <button mat-menu-item (click)="shakeCard(rightclicked_item.card, rightclicked_item.userid, 'hand')">Shake</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'zone'">
          <button mat-menu-item (click)="openSideNav(rightclicked_item.zone)">View Zone</button>
          <button mat-menu-item (click)="selectRandom(getZone(rightclicked_item.zone))">Select Random</button>
          <button mat-menu-item [matMenuTriggerFor]="sendAll">Send All To</button>
          <button mat-menu-item [matMenuTriggerFor]="revealAll">Reveal All To</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'zone_card'">
          <button mat-menu-item [matMenuTriggerFor]="sendTo">Send To</button>
          <button *ngIf="rightclicked_item.card.back_face" mat-menu-item (click)="altFaceCard(rightclicked_item.card)">Alt Face</button>
          <button *ngIf="rightclicked_item.zone === 'exile' || rightclicked_item.zone === 'temp_zone'" mat-menu-item (click)="flipCard(rightclicked_item.card)">Flip Face</button>
          <button mat-menu-item (click)="shakeCard(rightclicked_item.card, sidenav_selected_player.id, rightclicked_item.zone)">Shake</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'scry_card'">
          <button mat-menu-item [matMenuTriggerFor]="sendTo">Send To</button>
        </div>

        <div *ngIf="rightclicked_item.type === 'deck'">
          <button mat-menu-item>Flip Top</button>
          <button mat-menu-item *ngIf="game_data && game_data.current_turn == 0" (click)="startGame()">Start Game</button>
          <button mat-menu-item (click)="openSideNav('deck')">Search</button>
          <button mat-menu-item (click)="shuffleDeck(user.deck.cards, true)">Shuffle</button>
          <div>
            <mat-form-field appearance="standard" style="margin: 0 15px 0 15px; width: 125px">
              <mat-label>Scry</mat-label>
              <input #scry_count type="text" matInput (click)="$event.stopPropagation()" value="1">
              <button matSuffix mat-icon-button aria-label="Scry" (click)="scryX(scry_count.value)"><mat-icon>visibility</mat-icon></button>
            </mat-form-field>
          </div>
          <div>
            <mat-form-field appearance="standard" style="margin: 0 15px 0 15px; width: 125px">
              <mat-label>Draw</mat-label>
              <input #draw_count type="text" matInput (click)="$event.stopPropagation()" value="1">
              <button matSuffix mat-icon-button aria-label="Draw" (click)="drawX(draw_count.value)"><mat-icon>add_circle</mat-icon></button>
            </mat-form-field>
          </div>
          <div>
            <mat-form-field appearance="standard" style="margin: 0 15px 0 15px; width: 125px">
              <mat-label>Draw To</mat-label>
              <input [(ngModel)]="draw_to_count" type="text" matInput (click)="$event.stopPropagation()" value="1">
              <button matSuffix mat-icon-button aria-label="DrawTo" (click)="$event.stopPropagation()" [mat-menu-trigger-for]="drawTo"><mat-icon>navigate_next</mat-icon></button>
            </mat-form-field>
          </div>
          <div>
            <mat-form-field appearance="standard" style="margin: 0 15px 0 15px; width: 125px">
              <mat-label>Draw Until</mat-label>
              <input #draw_until type="text" matInput (click)="$event.stopPropagation()" value="">
              <button matSuffix mat-icon-button aria-label="DrawUntil" (click)="drawUntil(draw_until.value)"><mat-icon>fast_forward</mat-icon></button>
            </mat-form-field>
          </div>
          <div>
            <mat-form-field appearance="standard" style="margin: 0 15px 0 15px; width: 125px">
              <mat-label>Cascade</mat-label>
              <input #cascade_until type="text" matInput (click)="$event.stopPropagation()" value="">
              <button matSuffix mat-icon-button aria-label="Cascade" (click)="cascade(cascade_until.value)"><mat-icon>fast_forward</mat-icon></button>
            </mat-form-field>
          </div>
        </div>

        <div *ngIf="rightclicked_item.type === 'deck_card'">
          <button mat-menu-item [matMenuTriggerFor]="sendTo">Send To</button>
          <button mat-menu-item>Shake</button>
        </div>
      </div>
    </ng-template>
  </div>
</mat-menu>

<mat-menu #hand_menu="matMenu">
  <button mat-menu-item (click)="selectRandom(user.hand)" >Select Random</button>
  <button mat-menu-item [matMenuTriggerFor]="sendAll">Send All To</button>
  <button mat-menu-item [matMenuTriggerFor]="revealAll">Reveal All To</button>
  <div>
    <mat-form-field appearance="standard" style="margin: 0 15px 0 15px; width: 125px">
      <mat-label>Mulligan</mat-label>
      <input #mulligan type="text" matInput (click)="$event.stopPropagation()" value="7">
      <button matSuffix mat-icon-button aria-label="Draw" (click)="mulliganHand(mulligan.value)"><mat-icon>refresh</mat-icon></button>
    </mat-form-field>
  </div>
</mat-menu>

<mat-menu #counters="matMenu">
  <button mat-menu-item (click)="rightclicked_item.card.counter_1 = !rightclicked_item.card.counter_1">Counter 1</button>
  <button mat-menu-item (click)="rightclicked_item.card.counter_2 = !rightclicked_item.card.counter_2">Counter 2</button>
  <button mat-menu-item (click)="rightclicked_item.card.counter_3 = !rightclicked_item.card.counter_3">Counter 3</button>
  <button mat-menu-item (click)="rightclicked_item.card.multiplier = !rightclicked_item.card.multiplier">Multiplier</button>
</mat-menu>

<mat-menu #token_menu="matMenu">
  <div *ngIf="rightclicked_item && rightclicked_item.card && rightclicked_item.card.tokens">
    <button *ngFor="let token of rightclicked_item.card.tokens" mat-menu-item (click)="createToken(token)">Create {{token.name}} Token</button>
  </div>
</mat-menu>

<mat-menu #orient="matMenu">
  <button mat-menu-item (click)="altFaceCard(rightclicked_item.card)">Alt Face</button>
  <button mat-menu-item (click)="invertCard(rightclicked_item.card)">Invert</button>
  <button mat-menu-item (click)="flipCard(rightclicked_item.card)">Flip Face</button>
</mat-menu>

<mat-menu #sendTo="matMenu">
  <button mat-menu-item (click)="selectCard(rightclicked_item.card, rightclicked_item.from);sendCardToZone(rightclicked_item.card, rightclicked_item.from, 'hand')">Hand</button>
  <button mat-menu-item (click)="selectCard(rightclicked_item.card, rightclicked_item.from);sendCardToZone(rightclicked_item.card, rightclicked_item.from, 'grave')">Graveyard</button>
  <button mat-menu-item (click)="selectCard(rightclicked_item.card, rightclicked_item.from);sendCardToZone(rightclicked_item.card, rightclicked_item.from, 'exile')">Exile</button>
  <button mat-menu-item (click)="selectCard(rightclicked_item.card, rightclicked_item.from);sendCardToZone(rightclicked_item.card, rightclicked_item.from, 'deck')">Deck Top</button>
  <button mat-menu-item (click)="selectCard(rightclicked_item.card, rightclicked_item.from);sendCardToZone(rightclicked_item.card, rightclicked_item.from, 'deck_bottom')">Deck Bottom</button>
  <button mat-menu-item (click)="selectCard(rightclicked_item.card, rightclicked_item.from);sendCardToZone(rightclicked_item.card, rightclicked_item.from, 'temp_zone')">Temp Zone</button>
  <button mat-menu-item (click)="selectCard(rightclicked_item.card, rightclicked_item.from);sendCardToZone(rightclicked_item.card, rightclicked_item.from, 'selected')">Selected Player</button>
</mat-menu>

<mat-menu #sendAll="matMenu">
  <button mat-menu-item (click)="sendAllTo(getZone(rightclicked_item.zone), 'hand')">Hand</button>
  <button mat-menu-item (click)="sendAllTo(getZone(rightclicked_item.zone), 'grave')">Graveyard</button>
  <button mat-menu-item (click)="sendAllTo(getZone(rightclicked_item.zone), 'exile')">Exile</button>
  <button mat-menu-item (click)="sendAllTo(getZone(rightclicked_item.zone), 'deck')">Deck Top</button>
  <button mat-menu-item (click)="sendAllTo(getZone(rightclicked_item.zone), 'deck_bottom')">Deck Bottom</button>
  <button mat-menu-item (click)="sendAllTo(getZone(rightclicked_item.zone), 'temp_zone')">Temp Zone</button>
  <button mat-menu-item (click)="sendAllTo(getZone(rightclicked_item.zone), 'selected')">Selected Player</button>
</mat-menu>

<mat-menu #revealTo="matMenu">
  <div *ngIf="game_data != null">
    <button mat-menu-item *ngFor="let player of game_data.players" (click)="revealCard(rightclicked_item.card, player.id)">
      <div *ngIf="rightclicked_item && rightclicked_item.card">
        <mat-icon *ngIf="rightclicked_item.card.visible.includes(player.id)">visibility</mat-icon>
        <mat-icon *ngIf="!rightclicked_item.card.visible.includes(player.id)">visibility_off</mat-icon>
        <span>{{player.name}}</span>
      </div>
    </button>
    <button mat-menu-item (click)="revealCard(rightclicked_item.card, 'All')">All</button>
    <button mat-menu-item (click)="revealCard(rightclicked_item.card, 'None')">None</button>
  </div>
</mat-menu>

<mat-menu #revealAll="matMenu">
  <div *ngIf="game_data != null">
    <button mat-menu-item *ngFor="let player of game_data.players" (click)="revealAllTo(getZone(rightclicked_item.zone), player.id)">{{player.name}}</button>
    <button mat-menu-item (click)="revealAllTo(getZone(rightclicked_item.zone), 'All')">All</button>
    <button mat-menu-item (click)="revealAllTo(getZone(rightclicked_item.zone), 'None')">None</button>
  </div>
</mat-menu>

<mat-menu #play_counter="matMenu">
  <button mat-menu-item (click)="createCounter('play')">Play Counter</button>
  <button mat-menu-item (click)="createCounter('type')">Type Counter</button>
</mat-menu>

<mat-menu #drawTo="matMenu">
  <button mat-menu-item (click)="drawToX('grave')">Graveyard</button>
  <button mat-menu-item (click)="drawToX('exile')">Exile</button>
  <button mat-menu-item (click)="drawToX('temp_zone')">Temp Zone</button>
  <button mat-menu-item (click)="drawToX('play')">Play</button>
</mat-menu>



<div class="fddp-hover-holder" [style.display]="hovered_card || preview ? 'block': 'none'" [style.pointer-events]="preview ? 'all': 'none'">
  <mat-card class="fddp-hover-box" cdkDrag [cdkDragFreeDragPosition]="hoverdata.position">
    <div *ngIf="hovered_card">
      <img *ngIf="!hoverdata.shift_pressed && (!hoverdata.control_pressed || !hovered_card.back_face)" src="{{hovered_card.image}}" class="fddp-hover-image">
      <img *ngIf="!hoverdata.shift_pressed && hoverdata.control_pressed && hovered_card.back_face" src="{{hovered_card.back_image}}" class="fddp-hover-image">
      <div *ngIf="hoverdata.shift_pressed && (!hoverdata.control_pressed || !hovered_card.back_face)" fxFlexFill fxLayout="row" fxLayoutAlign="center center">
        <div fxLayout="column" fxLayoutAlign="center center" fxFlex>
          <div style="text-align: center">
            <h3 *ngIf="hovered_card.name" style="margin: 2px">{{hovered_card.name}}</h3>
            <h3 style="margin: 2px" *ngIf="hovered_card.is_token && !hovered_card.types.includes('Token') && !hovered_card.types.includes('Emblem')">(Copy)</h3>
            <h3 style="margin: 2px" *ngIf="hovered_card.is_token && hovered_card.types.includes('Token')">(Token)</h3>
            <h3 style="margin: 2px" *ngIf="hovered_card.is_token && hovered_card.types.includes('Emblem')">(Emblem)</h3>
            <mat-divider></mat-divider>
            <h3 *ngIf="hovered_card.mana_cost" style="margin: 2px">{{hovered_card.mana_cost.join(' ')}}</h3>
            <h3 *ngIf="hovered_card.types" style="margin: 2px">{{hovered_card.types.join(' ')}}</h3>
            <mat-divider></mat-divider>
            <h3 *ngIf="hovered_card.oracle_text" style="margin: 10px; white-space: pre-line">{{hovered_card.oracle_text}}</h3>
            <h3 *ngIf="hovered_card.power && hovered_card.power != null && hovered_card.toughness && hovered_card.toughness != null">
              {{hovered_card.power}}/{{hovered_card.toughness}}
            </h3>
            <h3 *ngIf="hovered_card.loyalty && hovered_card.loyalty !== null">{{hovered_card.loyalty}}</h3>
          </div>
        </div>
      </div>

      <div *ngIf="hoverdata.shift_pressed && hoverdata.control_pressed && hovered_card.back_face" fxFlexFill fxLayout="row" fxLayoutAlign="center center">
        <div fxLayout="column" fxLayoutAlign="center center">
          <div style="text-align: center">
            <h3 style="margin: 2px">{{hovered_card.name}}</h3>
            <mat-divider></mat-divider>
            <h3 style="margin: 2px">{{hovered_card.back_mana_cost.join(' ')}}</h3>
            <h3 style="margin: 2px">{{hovered_card.back_types.join(' ')}}</h3>
            <mat-divider></mat-divider>
            <h3 style="margin: 10px; white-space: pre-line">{{hovered_card.back_oracle_text}}</h3>
            <h3 *ngIf="hovered_card.back_power && hovered_card.back_power != null && hovered_card.back_toughness && hovered_card.back_toughness != null">
              {{hovered_card.back_power}}/{{hovered_card.back_toughness}}
            </h3>
            <h3 *ngIf="hovered_card.back_loyalty && hovered_card.back_loyalty !== null">{{hovered_card.back_loyalty}}</h3>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="preview" class="fddp-hover-handle" cdkDragHandle>
      <mat-icon>open_with</mat-icon>
    </div>
    <div *ngIf="preview" class="fddp-hover-minimize">
      <mat-icon (click)="togglePreview()">minimize</mat-icon>
    </div>
  </mat-card>
</div>

<div *ngIf="scrying" class="scrydata-holder">
  <div fxFlexFill fxLayout="row" fxLayoutAlign="center center">
    <mat-card fxFlex="70" class="scrydata-card-holder" fxLayout="column" fxLayoutAlign="start center">
      <div fxLayout="row" fxLayoutAlign="center">
        <h2>Scrying</h2>
      </div>

      <div fxLayout="row wrap" fxLayoutAlign="center start">
        <div *ngFor="let card of user.temp_scry_zone; let i = index" class="scrydata-card-container">
          <img class="scrydata-card" src="{{card.image}}"
               [ngClass]="{'mtg-card-user-selected': isSelected(card)}"
               (click)="toggleCardSelect(card, user.temp_scry_zone);"
               (contextmenu)="onRightClick($event,{type: 'scry_card', card: card});">
          <h1 class="scrydata-card-count">{{i + 1}}</h1>
        </div>
      </div>
      <div class="scrydata-card-close">
        <mat-icon (click)="endScry()">close</mat-icon>
      </div>
    </mat-card>
  </div>
</div>

<mat-sidenav-container fxFlexFill cdkDropListGroup hasBackdrop="false" *ngIf="user != null" style="overflow: hidden">
  <mat-sidenav #fddp_sidenav disableClose *ngIf="game_data != null" style="overflow: hidden">
    <mat-toolbar color="primary">
      <div fxFlex="100" fxLayout="row" fxLayoutAlign="space-between center">
        <h2 fxFlex *ngIf="sidenav_type==='grave'">Graveyards</h2>
        <h2 fxFlex *ngIf="sidenav_type==='exile'">Exile</h2>
        <h2 fxFlex *ngIf="sidenav_type==='temp_zone'">Temp Zones</h2>
        <h2 fxFlex *ngIf="sidenav_type==='deck'">Searching Deck</h2>
        <button mat-icon-button (click)="closeSideNav()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </mat-toolbar>
    <div>
    <div fxLayout="column">
      <div fxLayout="row" style="height: 64px">
        <mat-form-field appearance="outline" fxFlex style="margin: 5px;" *ngIf="sidenav_type !== 'deck'">
          <mat-label>Player</mat-label>
          <mat-select [(ngModel)]="sidenav_selected_player" name="player_select_sidenav" (ngModelChange)="getSidenavSort()">
            <mat-option *ngFor="let player of game_data.players" [value]="player">
              {{player.name}}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div fxLayout="row" style="height: 64px">
        <mat-form-field fxFlex style="margin: 5px;" appearance="outline">
          <mat-label>Search</mat-label>
          <input type="text" placeholder="Card Name"
                 matInput [matAutocomplete]="card_name"
                 [(ngModel)]="sidenav_sort" (ngModelChange)="getSidenavSort()">
          <mat-autocomplete #card_name>
            <mat-option *ngFor="let card of getSidenavList()" [value]="card.name">
              {{card.name}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>
      <div fxLayout="row" style="height: 64px">
        <mat-form-field fxFlex appearance="outline" style="margin: 5px;">
          <mat-label>Type</mat-label>
          <input type="text"
                 placeholder="Card Type"
                 matInput [(ngModel)]="sidenav_sort_type"
                 (ngModelChange)="getSidenavSort()">
        </mat-form-field>
      </div>
      <ng-scrollbar #scrollable
                    track="vertical"
                    pointerEventsMethod="scrollbar"
                    style="height: calc(100vh - 261px); width: 500px; margin-top: 5px;">
        <div class="sidenav-list" cdkDropList
             (cdkDropListDropped)="moveCardToZone($event, sidenav_type, true)"
             [cdkDropListData]="getSidenavList()">
          <div *ngFor="let card of getSidenavList()">
            <div *ngIf="card.sidenav_visible && (card.visible.includes(user.id) || sidenav_type === 'deck')" class="sidenav-list-item"
                 [ngClass]="{'sidenav-list-item-selected': isSelected(card)}"
                 (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
                 (cdkDragStarted)="hovered_card=null; selectCard(card, getSidenavList());"
                 (click)="toggleCardSelect(card, getSidenavList(), card.sidenav_visible)"
                 (contextmenu)="onRightClick($event, {type: 'zone_card', card: card, from: getSidenavList()})"
                 cdkDrag>
              {{card.name}}
              <img *cdkDragPreview [src]="card.image" [alt]="card.name" class="mtg-card-user" loading="lazy">
              <img *cdkDragPlaceholder class="mtg-card-user" [src]="card.image" [alt]="card.name" loading="lazy">
            </div>
            <div *ngIf="card.sidenav_visible && !card.visible.includes(user.id) && sidenav_type !== 'deck'" class="sidenav-list-item"
                 [ngClass]="{'sidenav-list-item-selected': isSelected(card)}"
                 (pointerenter)="hovered_card=null" (pointerleave)="hovered_card=null"
                 [cdkDragDisabled]="true" (contextmenu)="onRightClick($event, {type: 'zone_card', card: card, from: getSidenavList()})"
                 cdkDrag>
              -------- Hidden --------
            </div>
          </div>
        </div>
      </ng-scrollbar>
    </div>
  </div>
  </mat-sidenav>
  <mat-sidenav-content>
    <div *ngIf="user != null" class="counter-creator" fxLayout="column">
      <div class="counter-container">
        <!---->
        <div *ngFor="let counter of counts">
          <mat-card *ngIf="counter.type === 'type'" class="commander-dashboard-custom-counter"
                    (contextmenu)="onRightClick($event, {type: 'type_counter', counter: counter})"
                     style="padding: 0" cdkDrag (keydown.escape)="deleteCounter(counter)">
            <mat-form-field appearance="fill" class="commander-dashboard-input">
              <mat-label>Enter a Type</mat-label>
              <input #custom_search matInput>
            </mat-form-field>
            <div fxFlex="100" fxLayout="row" fxLayoutGap="10" class="commander-dashboard-select-holder" fxLayoutAlign="space-between">
              <mat-form-field appearance="outline" class="commander-dashboard-select">
                <mat-label>Player</mat-label>
                <mat-select #search_player>
                  <mat-option *ngFor="let player of game_data.players" [value]="player">{{player.name}}</mat-option>
                  <mat-option [value]="'All'">All</mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline" class="commander-dashboard-select">
                <mat-label>Zone</mat-label>
                <mat-select #search_zone>
                  <mat-option [value]="'play'">Play</mat-option>
                  <mat-option [value]="'grave'">Graveyard</mat-option>
                  <mat-option [value]="'exile'">Exile</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <h1 class="commander-dashboard-text" style="text-align: end">Count: {{typeCount(search_player.value, search_zone.value,  custom_search.value)}}</h1>
          </mat-card>
          <button *ngIf="counter.type === 'play'" cdkDrag mat-fab (click)="counter.value = counter.value + 1; this.updateCounter();"
                  (contextmenu)="onRightClick($event, {type: 'custom_counter', counter: counter})"
                  (keydown.escape)="deleteCounter(counter)"
                  [style.background]="counter.color"
                  style="pointer-events: all;">{{counter.value}}</button>
        </div>
      </div>
    </div>
    <div class="player-list" *ngIf="game_data != null">
      <mat-card style="padding:5px 10px 0 0">
        <mat-list>
          <mat-divider></mat-divider>
          <div *ngFor="let player of game_data.players; let j = index">
            <mat-list-item [ngClass]="{'player-button-selected': player.selected,
                                'player-button-turn': player.turn == game_data.current_turn}">
              <div fxLayout="row" fxLayoutAlign="space-between center" fxFlexFill>
                <div fxLayout="column" fxFlex="100">
                  <button (pointerenter)="hovered_card=isOpponent(player) ? player.deck.commander_saved[0]: null" (pointerleave)="hovered_card=null"
                    class="player-button"
                    mat-button
                    (click)="selectPlayer(player)">
                    {{player.name}}
                  </button>
                </div>
                <div fxLayout="column" fxFlex="100">
                  <div fxLayout="row" fxFlex>
                    <div class="column" fxFlex>
                      <button (pointerenter)="hovered_card=player.deck.commander_saved.length>1 ? player.deck.commander_saved[1] : null" (pointerleave)="hovered_card=null" *ngIf="isOpponent(player)" class="player-button" mat-button disabled style="color: white">
                        {{player.life}}
                      </button>
                      <button *ngIf="!isOpponent(player)" class="player-button" mat-button
                              (click)="player.life = player.life + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'life', player: player})">
                        {{player.life}}
                      </button>
                    </div>
                    <div class="column" fxFlex>
                      <button *ngIf="isOpponent(player)" class="player-button" mat-button disabled style="color: white">
                        {{player.infect}}
                      </button>
                      <button *ngIf="!isOpponent(player)" class="player-button" mat-button
                              (click)="player.infect = player.infect + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'infect', player: player})">
                        {{player.infect}}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </mat-list-item>
            <mat-divider *ngIf="j != game_data.players.length - 1"></mat-divider>
          </div>
        </mat-list>
      </mat-card>
    </div>
    <div fxFlexFill (contextmenu)="onRightClick($event, {type: 'none'})" *ngIf="user != null">
      <div class="container" fxLayout="row" fxLayoutAlign="center end" fxFlexFill>
        <div fxLayout="column" fxLayoutAlign="start center" fxFlexFill style="margin: 10px;">
          <!-- &&Opponents -->
          <div class="opponent-holder" fxFlex="100" fxLayout="row" fxLayoutAlign="center center">
              <div class="opponent-playmat-holder" fxLayout="row wrap" fxLayout.lt-md="column" fxLayoutAlign="center" *ngIf="game_data">
                <div *ngFor="let player of game_data.players">
                  <mat-card *ngIf="isOpponent(player)" class="playmat-opponent" fxLayout="row wrap" fxLayoutAlign="center center">
                    <div class="playmat-opponent-data" (contextmenu)="onRightClick($event, {type: 'opponent_playmat'})">
                      <div class="opponent-information" fxFlexFill fxLayout="row" fxLayoutAlign="space-between" *ngIf="player.hand && player.deck.cards && player.grave && player.exile">
                        <h3>{{player.name}}</h3>
                        <h3 style="pointer-events: none">Hand: {{player.hand.length}}, Deck: {{player.deck.cards.length}}, Graveyard: {{player.grave.length}}, Exile: {{player.exile.length}}</h3>
                      </div>
                      <div class="playmat-opponent-selector" [ngClass]="{'playmat-opponent-turn': player.turn == game_data.current_turn, 'playmat-opponent-selected': player.selected}"></div>
                      <div class="playmat-opponent-card-data">
                        <div *ngFor="let spot of reversePlaymat(player.playmat)" class="mtg-card-holder-opponent">
                          <div *ngFor="let card of spot; let i = index">
                            <div [ngClass]="{'stack-1': i == 0,'stack-2': i == 1,'stack-3': i == 2, 'mtg-card-invert': card.inverted, 'mtg-card-clone': card.is_token && !card.types.includes('Token') && !card.types.includes('Emblem')}" class="mtg-card-opponent-container"
                                 (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null" [@opponentTappedState]="card.tapped"
                                 [@shakeCard]="card.shaken">
                              <img class="mtg-card-opponent"
                                   [src]="card.visible.includes(user.id) ? card.image: player.deck.sleeves"
                                   [alt]="card.visible.includes(user.id) ? card.name: ''"
                                   loading="lazy" (contextmenu)="onRightClick($event,{type: 'opponent_play', card: card, spot: spot, userid: player.id})">

                              <button *ngIf="card.counter_1" class="mtg-counter-1" mat-fab color="primary" [class.mat-elevation-z8]="true"><p>{{card.counter_1_value}}</p></button>
                              <button *ngIf="card.counter_2" class="mtg-counter-2" mat-fab color="accent" [class.mat-elevation-z8]="true"><p>{{card.counter_2_value}}</p></button>
                              <button *ngIf="card.counter_3" class="mtg-counter-3" mat-fab color="warn" [class.mat-elevation-z8]="true"><p>{{card.counter_3_value}}</p></button>
                              <button *ngIf="card.multiplier" class="mtg-multiplier-counter" mat-fab color="accent" [class.mat-elevation-z8]="true"><p>{{card.multiplier_value}}</p></button>

                              <h5 *ngIf="card.power && card.toughness && card.power != null && card.toughness != null && card.visible.includes(user.id)" class="mtg-card-power-tough">
                                <a [ngClass]="{'mat-card-power-tough-text-up': card.power_mod > 0, 'mat-card-power-tough-text-down': card.power_mod < 0}" class="mat-card-power-tough-text">{{card.power + card.power_mod}}</a>/
                                <a [ngClass]="{'mat-card-power-tough-text-up': card.toughness_mod > 0, 'mat-card-power-tough-text-down': card.toughness_mod < 0}" class="mat-card-power-tough-text">{{card.toughness + card.toughness_mod}}</a></h5>
                              <h5 *ngIf="card.loyalty && card.loyalty != null && card.visible.includes(user.id)" class="mtg-card-loyalty"><a class="mat-card-power-tough-text" [ngClass]="{'mat-card-power-tough-text-up': card.loyalty_mod > 0, 'mat-card-power-tough-text-down': card.loyalty_mod < 0}">{{card.loyalty + card.loyalty_mod}}</a></h5>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </mat-card>
                </div>
              </div>
          </div>
          <!-- &&Playmat User -->
          <div fxLayout="row" fxFlex fxLayoutAlign="center">
            <div class="playmat-user-holder" *ngIf="user != null">
              <div class="playmat-user-devotions" >
                <div fxFlexFill fxLayout="column" fxLayoutAlign="space-evenly start">
                  <div class="devotion-holder">
                    <button mat-fab class="devotion-white">{{devotionCount(user, 'W')}}</button>
                  </div>
                  <div class="devotion-holder">
                    <button mat-fab class="devotion-blue">{{devotionCount(user, 'U')}}</button>
                  </div>
                  <div class="devotion-holder">
                    <button mat-fab class="devotion-black">{{devotionCount(user, 'B')}}</button>
                  </div>
                  <div class="devotion-holder">
                    <button mat-fab class="devotion-red">{{devotionCount(user, 'R')}}</button>
                  </div>
                  <div class="devotion-holder">
                    <button mat-fab class="devotion-green">{{devotionCount(user, 'G')}}</button>
                  </div>
                </div>
              </div>
              <mat-card class="playmat-user" fxLayout="row wrap" fxLayoutAlign="start start">
                <div *ngFor="let spot of user.playmat"
                     class="mtg-card-holder-user"
                     cdkDropList
                     [cdkDropListData]="spot"
                     (cdkDropListDropped)="moveCardToZone($event, 'play')"
                      (dblclick)="sendSelectedToSpot(spot, 'play')"
                     (contextmenu)="onRightClick($event, {type: 'user_playmat', spot: spot, from: spot})">
                  <div *ngFor="let card of spot; let i = index" (dblclick)="$event.stopPropagation()">
                    <div [ngClass]="{'stack-1': i == 0, 'stack-2': i == 1, 'stack-3': i == 2, 'mtg-card-invert': card.inverted}"
                         (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
                         (cdkDragStarted)="hovered_card=null; selectCard(card, spot);"
                         class="mtg-card-user-container" [@userTappedState]="card.tapped"
                         [@shakeCard]="card.shaken"
                         cdkDrag>
                      <div *ngIf="card.locked" class="mtg-lock"><mat-icon>lock</mat-icon></div>
                      <img [ngClass]="{'mtg-card-user-selected': isSelected(card), 'mtg-card-clone': card.is_token && !card.types.includes('Token') && !card.types.includes('Emblem') }"
                           class="mtg-card-user"
                           [src]="card.visible.includes(user.id) ? card.image: user.deck.sleeves"
                           [alt]="card.visible.includes(user.id) ? card.name: ''"
                           (contextmenu)="onRightClick($event,{type: 'user_play', card: card, spot: spot, from: spot}); selectCard(card, spot);"
                           (click)="toggleCardSelect(card, spot)" (dblclick)="tapCard(card)" loading="lazy">
                      <button *ngIf="card.counter_1" class="mtg-counter-1" mat-fab color="primary" [class.mat-elevation-z8]="true" (click)="card.counter_1_value = card.counter_1_value + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'counter_1', card: card})"><p>{{card.counter_1_value}}</p></button>
                      <button *ngIf="card.counter_2" class="mtg-counter-2" mat-fab color="accent" [class.mat-elevation-z8]="true" (click)="card.counter_2_value = card.counter_2_value + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'counter_2', card: card})"><p>{{card.counter_2_value}}</p></button>
                      <button *ngIf="card.counter_3" class="mtg-counter-3" mat-fab color="warn" [class.mat-elevation-z8]="true" (click)="card.counter_3_value = card.counter_3_value + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'counter_3', card: card})"><p>{{card.counter_3_value}}</p></button>
                      <button *ngIf="card.multiplier" class="mtg-multiplier-counter" mat-fab color="accent" [class.mat-elevation-z8]="true" (click)="card.multiplier_value = card.multiplier_value + 1" (contextmenu)="onRightClick($event, {type: 'multiplier', card: card})"><p>{{card.multiplier_value}}</p></button>
                      <h4 *ngIf="card.power && card.toughness && card.visible.includes(user.id)" class="mtg-card-power-tough">
                        <a [ngClass]="{'mat-card-power-tough-text-up': card.power_mod > 0, 'mat-card-power-tough-text-down': card.power_mod < 0}" class="mat-card-power-tough-text" (click)="card.power_mod = card.power_mod + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'power', card: card})">{{card.power + card.power_mod}}</a>/
                        <a [ngClass]="{'mat-card-power-tough-text-up': card.toughness_mod > 0, 'mat-card-power-tough-text-down': card.toughness_mod < 0}" class="mat-card-power-tough-text" (click)="card.toughness_mod = card.toughness_mod + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'toughness', card: card})">{{card.toughness + card.toughness_mod}}</a></h4>
                      <h4 *ngIf="card.loyalty && card.visible.includes(user.id)" class="mtg-card-loyalty"><a class="mat-card-power-tough-text" [ngClass]="{'mat-card-power-tough-text-up': card.loyalty_mod > 0, 'mat-card-power-tough-text-down': card.loyalty_mod < 0}" (click)="card.loyalty_mod = card.loyalty_mod + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'loyalty', card: card})">{{card.loyalty + card.loyalty_mod}}</a></h4>
                    </div>
                  </div>
                </div>
              </mat-card>
            </div>
          </div>
          <!-- Opponent Hand -->
          <div fxLayout="row" fxFlex fxLayoutAlign="center">
            <div class="opponent-hand" fxLayout="column" fxLayoutAlign="center" [class.mat-elevation-z8]="selected_player != null">

                <div *ngIf="selected_player != null" class="opponent-hand-list"
                   fxFlex fxLayout="row" fxLayoutAlign="center start">
                  <h1 class="hand-count">{{selected_player.hand.length}}</h1>
                  <img *ngFor="let card of selected_player.hand"
                       class="mtg-card-opponent"
                       [src]="card.visible.includes(user.id) ? card.image: selected_player.deck.sleeves"
                       [alt]="card.visible.includes(user.id) ? card.name: ''"
                       (contextmenu)="onRightClick($event, {type: 'opponent_hand', card: card, userid: selected_player.id})"
                       (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null" loading="lazy" [@shakeCard]="card.shaken">
                </div>

            </div>
          </div>
          <!-- User Hand -->
          <div fxLayout="row" fxFlex fxLayoutAlign="center">
            <div class="user-hand" fxLayout="column" fxLayoutAlign="center" [class.mat-elevation-z8]="true">
              <div cdkDropList class="user-hand-list"
                   cdkDropListOrientation="horizontal"
                   [cdkDropListData]="user.hand"
                   (cdkDropListDropped)="moveCardToZone($event, 'hand')" fxFlexFill fxLayout="row" fxLayoutAlign="start">
                <h1 class="hand-count">{{user.hand.length}}</h1>
                <mat-icon [mat-menu-trigger-for]="hand_menu" class="hand-menu">more_vert</mat-icon>
                <mat-card *ngFor="let card of user.hand" class="mtg-card-user-container"
                     fxFlex fxLayout="column"
                     (contextmenu)="onRightClick($event, {type: 'user_hand', card: card, from: user.hand}); selectCard(card, user.hand);"
                     (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
                     (click)="toggleCardSelect(card, user.hand)"
                     (cdkDragStarted)="hovered_card=null; selectCard(card, user.hand);" [@shakeCard]="card.shaken"
                     cdkDrag>
                  <img [ngClass]="{ 'mtg-card-user-selected': isSelected(card) }"
                       class="mtg-card-user"
                       [src]="card.visible.includes(user.id) ? card.image: user.deck.sleeves"
                       [alt]="card.visible.includes(user.id) ? card.name: ''"
                       loading="lazy">
                </mat-card>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="user-deck">
        <mat-card class="zone-data"
             (dblclick)="drawX(1)"
             (contextmenu)="onRightClick($event, {type: 'deck'})"
             cdkDropList [cdkDropListData]="user.deck.cards"
             cdkDropListOrientation="horizontal"
             (cdkDropListDropped)="moveCardToZone($event, 'deck')">
          <h1 class="zone-count">{{user.deck.cards.length}}</h1>
          <img class="mtg-card-user"
               [src]="user.deck.cards.length > 0 && user.deck.cards[0].visible.includes(user.id) ? user.deck.cards[0].image: user.deck.sleeves"
               [alt]="user.deck.cards.length > 0 && user.deck.cards[0].visible.includes(user.id) ? user.deck.cards[0].name: ''"
               (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null; clearSelection(); selectCard(user.deck.cards[0], user.deck.cards);"
               cdkDrag loading="lazy">
        </mat-card>
      </div>
      <div class="zone-hider-outer" *ngIf="user != null">
        <div class="zone-hider-inner">
          <div [ngClass]="{'zone-container': !hidden, 'zone-container-hidden': hidden}">
            <div class="zone-holder">
              <!--<button [style.display]="'none'" mat-mini-fab class="zone-toggle-button"
              (click)="hidden=!hidden"><mat-icon
                [ngClass]="{'zones-arrow-on': !hidden, 'zones-arrow-off': hidden}">keyboard_arrow_right</mat-icon></button>-->
              <div class="user-grave">
                <mat-card class="zone-data" (dblclick)="sendSelectedToSpot(user.grave, 'grave')"
                          (contextmenu)="onRightClick($event, {type: 'zone', zone: 'grave'})"
                          cdkDropList [cdkDropListData]="user.grave"
                          cdkDropListOrientation="horizontal"
                          (cdkDropListDropped)="moveCardToZone($event, 'grave')">
                  <div class="zone-title"><h5>Graveyard</h5></div>
                  <h1 class="zone-count">{{user.grave.length}}</h1>
                  <div *ngIf="user.grave.length == 0" class="mtg-card-user"></div>
                  <img *ngIf="user.grave.length > 0" class="mtg-card-user"
                       [src]="user.grave[0].visible.includes(user.id) ? user.grave[0].image: user.deck.sleeves"
                       [alt]="user.grave[0].visible.includes(user.id) ? user.grave[0].name: ''"
                       (pointerleave)="hovered_card=null"
                       (cdkDragStarted)="hovered_card=null; selectCard(user.grave[0], user.grave);"
                       cdkDrag loading="eager">
                </mat-card>
              </div>
              <div class="user-exile">
                <mat-card class="zone-data" (dblclick)="sendSelectedToSpot(user.exile, 'exile')"
                          (contextmenu)="onRightClick($event, {type: 'zone', zone: 'exile'})"
                          cdkDropList [cdkDropListData]="user.exile"
                          cdkDropListOrientation="horizontal"
                          (cdkDropListDropped)="moveCardToZone($event, 'exile')">
                  <div class="zone-title"><h5>Exile</h5></div>
                  <h1 class="zone-count">{{user.exile.length}}</h1>
                  <div *ngIf="user.exile.length == 0" class="mtg-card-user"></div>
                  <img *ngIf="user.exile.length > 0" class="mtg-card-user"
                       [src]="user.exile[0].visible.includes(user.id) ? user.exile[0].image: user.deck.sleeves"
                       [alt]="user.exile[0].visible.includes(user.id) ? user.exile[0].name: ''"
                       src="{{user.exile[0].image}}"
                       (pointerleave)="hovered_card=null"
                       (cdkDragStarted)="hovered_card=null; selectCard(user.exile[0], user.exile);"
                       cdkDrag loading="eager">
                </mat-card>
              </div>
              <div class="user-temp-zone">
                <mat-card class="zone-data" (dblclick)="sendSelectedToSpot(user.temp_zone, 'temp_zone')"
                          (contextmenu)="onRightClick($event, {type: 'zone', zone: 'temp_zone'})"
                          cdkDropList [cdkDropListData]="user.temp_zone"
                          cdkDropListOrientation="horizontal"
                          (cdkDropListDropped)="moveCardToZone($event, 'temp_zone')">
                  <div class="zone-title"><h5>Temp</h5></div>
                  <h1 class="zone-count">{{user.temp_zone.length}}</h1>
                  <div *ngIf="user.temp_zone.length == 0" class="mtg-card-user"></div>
                  <img *ngIf="user.temp_zone.length > 0" class="mtg-card-user"
                       [src]="user.temp_zone[0].visible.includes(user.id) ? user.temp_zone[0].image: user.deck.sleeves"
                       [alt]="user.temp_zone[0].visible.includes(user.id) ? user.temp_zone[0].name: ''"
                       (pointerleave)="hovered_card=null"
                       (cdkDragStarted)="hovered_card=null; selectCard(user.temp_zone[0], user.temp_zone);"
                       cdkDrag loading="eager">
                </mat-card>
              </div>
              <div class="commander-viewer" cdkDropList
                   [cdkDropListData]="user.deck.commander"
                   (cdkDropListDropped)="moveCardToZone($event, 'command_zone')"
                   (contextmenu)="onRightClick($event, {type: 'commander'});">
                <mat-card class="commander-viewer-mat-card">
                  <div class="commander-counter-holder">
                    <div class="commander-counter-container">
                      <button mat-fab class="commander-counter commander-counter-1" (click)="user.command_tax_1 = user.command_tax_1 + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'command_tax_1'})">
                        {{user.command_tax_1}}
                      </button>
                      <button *ngIf="user.deck.commander_saved.length == 2" mat-fab color="primary" class="commander-counter commander-counter-2" (click)="user.command_tax_2 = user.command_tax_2 + 1; this.updateCounter();" (contextmenu)="onRightClick($event, {type: 'command_tax_2'})">
                        {{user.command_tax_2}}
                      </button>
                    </div>
                  </div>
                  <div *ngIf="user.deck.commander.length == 1">
                    <img class="commander-viewer-single"
                         src="{{user.deck.commander[0].image}}"
                         loading="lazy"
                         (contextmenu)="onRightClick($event, {type: 'commander', card: user.deck.commander[0]});
                                  selectCard(user.deck.commander[0], user.deck.commander, true);"
                         (pointerenter)="hovered_card=user.deck.commander[0]" (pointerleave)="hovered_card=null"
                          cdkDrag
                         (cdkDragStarted)="hovered_card=null; selectCard(user.deck.commander[0], user.deck.commander);">
                  </div>
                  <div *ngIf="user.deck.commander.length == 2" class="commander-viewer-partner-holder">
                    <div class="commander-viewer-partner-1"
                         (pointerenter)="hovered_card=user.deck.commander[0]"
                         (pointerleave)="hovered_card=null"
                         cdkDrag
                         (cdkDragStarted)="hovered_card=null; selectCard(user.deck.commander[0], user.deck.commander);"
                         (contextmenu)="onRightClick($event, {type: 'commander', card: user.deck.commander[0]}); selectCard(user.deck.commander[0], user.deck.commander, true);">
                      <img class="commander-viewer-partner-image" src="{{user.deck.commander[0].image}}" loading="lazy">
                    </div>
                   <div class="commander-viewer-partner-2"
                        (pointerenter)="hovered_card=user.deck.commander[1]"
                        (pointerleave)="hovered_card=null"
                        cdkDrag
                        (cdkDragStarted)="hovered_card=null; selectCard(user.deck.commander[1], user.deck.commander);"
                        (contextmenu)="onRightClick($event, {type: 'commander', card: user.deck.commander[1]}); selectCard(user.deck.commander[1], user.deck.commander, true);">
                     <img class="commander-viewer-partner-image" src="{{user.deck.commander[1].image}}" loading="lazy">
                   </div>
                  </div>
                </mat-card>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>

