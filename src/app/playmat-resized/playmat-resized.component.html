<div style="visibility: hidden; position: fixed"
     [style.left]="menuTopLeftPosition.x"
     [style.top]="menuTopLeftPosition.y"
     [matMenuTriggerFor]="rightMenu">
</div>

<mat-menu #rightMenu="matMenu">
  <div (click) = "$event.stopPropagation()">
    <ng-template matMenuContent>
      <button mat-menu-item (click)="untapAll()">Untap All</button>
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'deck'">
        <div>
          <button mat-button (click)="drawCard(current_draw)">Draw</button>
          <input matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white" [(ngModel)]="current_draw">
        </div>
        <div>
          <button mat-button (click)="drawToZone(current_drawto, 'play')">Draw to Play</button>
          <input matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white" [(ngModel)]="current_drawto">
        </div>
        <div>
          <button mat-button (click)="drawToZone(current_drawto, 'grave')">Draw to Grave</button>
          <input matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white" [(ngModel)]="current_drawto">
        </div>
        <div>
          <button mat-button (click)="drawToZone(current_drawto, 'exile')">Draw to Exile</button>
          <input matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white" [(ngModel)]="current_drawto">
        </div>
        <div>
          <button mat-button (click)="drawToZone(current_drawto, 'temp_zone')">Draw to Temp</button>
          <input matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white" [(ngModel)]="current_drawto">
        </div>
        <div>
          <button mat-button (click)="drawToOtherTempZone(current_drawto, selected_player)">Send to Selected</button>
          <input matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white" [(ngModel)]="current_drawto">
        </div>
        <button mat-menu-item>Shuffle</button>
        <button mat-menu-item (click)="nextTurn()">Next Turn</button>
      </div>
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'hand'">
        <button mat-menu-item (click)="sendToField(rightclicked_item.card, rightclicked_item.from)">Send to Field</button>
        <button mat-menu-item>Send to Deck</button>
        <button mat-menu-item (click)="sendToTempZone(rightclicked_item.card, rightclicked_item.from, selected_player)">Send to Selected</button>
      </div>
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'inPlayUser'">
        <button mat-menu-item (click)="tapSpot(rightclicked_item.spot)">(un)Tap Stack</button>
        <button mat-menu-item (click)="sendToTempZone(rightclicked_item.card, rightclicked_item.spot, selected_player)">Send to Selected</button>
      </div>
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'grave'">
        <button mat-menu-item (click)="openSideNav('grave')">View Graveyards</button>
      </div>
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'exile'">
        <button mat-menu-item (click)="openSideNav('exile')">View Exiles</button>
      </div>
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'temp-zone'">
        <button mat-menu-item (click)="openSideNav('temp_zone')">View Temp Zones</button>
      </div>
    </ng-template>
  </div>
</mat-menu>

<mat-sidenav-container fxFlexFill cdkDropListGroup hasBackdrop="false">
  <mat-sidenav #fddp_sidenav (keydown.escape)="fddp_sidenav.close()" disableClose>
    <mat-toolbar color="primary">
      <div fxFlex fxLayout="row">
        <button mat-icon-button (click)="closeSideNav()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </mat-toolbar>
    <div *ngIf="sidenav_type === 'grave'">
      <div fxLayout="column">
        <mat-form-field fxFlex style="margin: 5px;" appearance="outline">
          <mat-label>Search</mat-label>
          <input type="text" placeholder="Card Name"
                 matInput [matAutocomplete]="card_name"
                 [(ngModel)]="sidenav_sort" (ngModelChange)="getSidenavSort(sidenav_selected_player.grave)">
          <mat-autocomplete #card_name>
            <mat-option *ngFor="let card of sidenav_selected_player.grave" [value]="card.name">
              {{card.name}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <div class="sidenav-list" cdkDropList
             (cdkDropListDropped)="moveCardToGrave($event)"
             [cdkDropListData]="sidenav_selected_player.grave">
          <div *ngFor="let card of sidenav_selected_player.grave"
               class="sidenav-list-item"
               [ngClass]="{'sidenav-list-item-selected': card.selected}"
               (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null"
               (click)="toggleCardSelect(card, sidenav_selected_player.grave, card.sidenav_visible)"
               [cdkDragDisabled]="!card.sidenav_visible"
               cdkDrag>
            {{card.name}}
            <img *cdkDragPreview [src]="card.image" [alt]="card.name" class="mtg-card-user">
            <img *cdkDragPlaceholder class="mtg-card-user" [src]="card.image" [alt]="card.name">
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="sidenav_type === 'exile'">
      <div fxLayout="column">
        <mat-form-field fxFlex style="margin: 5px;" appearance="outline">
          <mat-label>Search</mat-label>
          <input type="text" placeholder="Card Name"
                 matInput [matAutocomplete]="card_name"
                 [(ngModel)]="sidenav_sort" (ngModelChange)="getSidenavSort(sidenav_selected_player.exile)">
          <mat-autocomplete #card_name>
            <mat-option *ngFor="let card of sidenav_selected_player.exile" [value]="card.name">
              {{card.name}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <div class="sidenav-list" cdkDropList
             (cdkDropListDropped)="moveCardToExile($event)"
             [cdkDropListData]="sidenav_selected_player.exile">
          <div *ngFor="let card of sidenav_selected_player.exile"
               class="sidenav-list-item"
               [ngClass]="{'sidenav-list-item-selected': card.selected}"
               (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null"
               (click)="toggleCardSelect(card, sidenav_selected_player.exile, card.sidenav_visible)"
               [cdkDragDisabled]="!card.sidenav_visible"
               cdkDrag>
            {{card.name}}
            <img *cdkDragPreview [src]="card.image" [alt]="card.name" class="mtg-card-user">
            <img *cdkDragPlaceholder class="mtg-card-user" [src]="card.image" [alt]="card.name">
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="sidenav_type === 'temp_zone'">
      <div fxLayout="column">
        <mat-form-field fxFlex style="margin: 5px;" appearance="outline">
          <mat-label>Search</mat-label>
          <input type="text" placeholder="Card Name"
                 matInput [matAutocomplete]="card_name"
                 [(ngModel)]="sidenav_sort" (ngModelChange)="getSidenavSort(sidenav_selected_player.grave)">
          <mat-autocomplete #card_name>
            <mat-option *ngFor="let card of sidenav_selected_player.temp_zone" [value]="card.name">
              {{card.name}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <div class="sidenav-list" cdkDropList
             (cdkDropListDropped)="moveCardToTempZone($event)"
             [cdkDropListData]="sidenav_selected_player.temp_zone">
          <div *ngFor="let card of sidenav_selected_player.temp_zone"
               class="sidenav-list-item"
               [ngClass]="{'sidenav-list-item-selected': card.selected}"
               (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null"
               (click)="toggleCardSelect(card, sidenav_selected_player.temp_zone, card.sidenav_visible)"
               [cdkDragDisabled]="!card.sidenav_visible"
               cdkDrag>
            {{card.name}}
            <img *cdkDragPreview [src]="card.image" [alt]="card.name" class="mtg-card-user">
            <img *cdkDragPlaceholder class="mtg-card-user" [src]="card.image" [alt]="card.name">
          </div>
        </div>
      </div>
    </div>
  </mat-sidenav>
  <mat-sidenav-content>
    <div class="card-preview" *ngIf="hovered_card">
      <mat-card fxLayout="row" fxLayoutAlign="start start" fxFlexFill>
        <div fxLayout="column" fxLayoutAlign="start center" fxFlex="100">
          <img class="mtg-card-preview" src="{{hovered_card.image}}" alt="{{hovered_card.name}}">
          <h3 style="text-align: center">{{hovered_card.name}}</h3>
          <h3 style="text-align: center">{{hovered_card.mana}}</h3>
          <h3 style="margin: 10px; white-space: pre-line">{{hovered_card.text}}</h3>
        </div>
      </mat-card>
    </div>
    <div class="player-list">
      <mat-list>
        <mat-divider></mat-divider>
        <div *ngFor="let player of players; let j = index">
          <mat-list-item [ngClass]="{'player-button-selected': player.selected,
                                  'player-button-turn': player.turn == current_turn}">
            <div fxLayout="row" fxLayoutAlign="space-between center" fxFlexFill>
              <div fxLayout="column" fxFlex="100">
                <button
                  class="player-button"
                  matTooltip="Hand: {{player.hand.length}} Deck: {{player.deck.length}} Grave: {{player.grave.length}} Exile: {{player.exile.length}}"
                  matTooltipPosition="right"
                  matTooltipShowDelay="1000"
                  mat-button
                  (click)="selectPlayer(player)">
                  {{player.name}}
                </button>
              </div>
              <div fxLayout="column" fxFlex="100">
                <div fxLayout="row" fxFlex>
                  <div class="column" fxFlex>
                    <button *ngIf="isOpponent(player)" class="player-button" mat-button disabled style="color: white">
                      {{player.life}}
                    </button>
                    <button *ngIf="!isOpponent(player)" class="player-button" mat-button
                            (click)="player.life = player.life + 1" (contextmenu)="onRightClick($event, {type: 'life', player: player})">
                      {{player.life}}
                    </button>
                  </div>
                  <div class="column" fxFlex>
                    <button *ngIf="isOpponent(player)" class="player-button" mat-button disabled style="color: white">
                      {{player.infect}}
                    </button>
                    <button *ngIf="!isOpponent(player)" class="player-button" mat-button
                            (click)="player.infect = player.infect + 1" (contextmenu)="onRightClick($event, {type: 'infect', player: player})">
                      {{player.infect}}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </mat-list-item>
          <mat-divider *ngIf="j != players.length - 1"></mat-divider>
        </div>
      </mat-list>
    </div>

    <div fxFlexFill (contextmenu)="onRightClick($event, {type: 'none'})">
      <div class="container" fxLayout="row" fxLayoutAlign="center end" fxFlexFill>
        <div fxLayout="column" fxLayoutAlign="start center" fxFlexFill style="margin: 10px;">
          <!-- Opponents -->
          <div class="opponent-holder" fxFlex="100" fxLayout="row" fxLayoutAlign="center center">
            <div class="opponent-playmat-holder" fxLayout="row wrap" fxLayout.lt-md="column" fxLayoutAlign="center">
              <div *ngFor="let player of players">
                <div *ngIf="isOpponent(player)" class="playmat-opponent" [ngClass]="{'playmat-opponent-selected': player.selected}" fxLayout="row wrap" fxLayoutAlign="center center">
                  <div *ngFor="let spot of reverse(user_playmat)" class="mtg-card-holder-opponent">
                    <div *ngFor="let card of spot; let i = index">
                      <img
                        [ngClass]="
                {
                  'stack-1': i == 0,
                  'stack-2': i == 1,
                  'stack-3': i == 2
                }"
                        [@opponentTappedState]="card.tapped"
                        class="mtg-card-opponent mtg-card-opponent-play"
                        src="{{card.image}}"
                        alt="{{card.name}}"
                        (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- User Playmat -->
          <div fxLayout="row" fxFlex fxLayoutAlign="center">
            <div class="playmat-user" fxLayout="row wrap" fxLayoutAlign="start start">
              <div *ngFor="let spot of user_playmat"
                   class="mtg-card-holder-user"
                   cdkDropList
                   [cdkDropListData]="spot"
                   (cdkDropListDropped)="moveCardToPlay($event)">
                <div *ngFor="let card of spot; let i = index">
                  <div [ngClass]="{'stack-1': i == 0, 'stack-2': i == 1, 'stack-3': i == 2}"
                       (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
                       (contextmenu)="onRightClick($event,{type: 'inPlayUser', card: card, spot: spot})"
                       (dblclick)="tapCard(card)"
                       (cdkDragStarted)="hovered_card=null" (click)="toggleCardSelect(card, spot)"
                       class="mtg-card-user-container" [@userTappedState]="card.tapped"
                       cdkDrag>
                    <img [ngClass]="{'mtg-card-user-selected': card.selected }"
                         class="mtg-card-user"
                         src="{{card.image}}"
                         alt="{{card.name}}">
                  </div>

                </div>
              </div>
            </div>
          </div>
          <!-- Opponent Hand -->
          <div fxLayout="row" fxFlex fxLayoutAlign="center">
            <div class="opponent-hand" fxLayout="column" fxLayoutAlign="center">
              <div *ngIf="selected_player != null" class="opponent-hand-list"
                   fxFlex fxLayout="row" fxLayoutAlign="start">
                <h1 class="hand-count">{{selected_player.hand.length}}</h1>
                <img *ngFor="let card of selected_player.hand" fxFlex fxLayout="column"
                     class="mtg-card-opponent"
                     src="{{card.image}}" alt="{{card.name}}"
                     (contextmenu)="onRightClick($event, {type: 'opponent_hand', card: card})"
                     (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null">
              </div>
            </div>
          </div>
          <!-- User Hand -->
          <div fxLayout="row" fxFlex fxLayoutAlign="center">
            <div class="user-hand" fxLayout="column" fxLayoutAlign="center">
              <div cdkDropList class="user-hand-list"
                   cdkDropListOrientation="horizontal"
                   [cdkDropListData]="user.hand"
                   (cdkDropListDropped)="moveCardToHand($event)" fxFlex fxLayout="row" fxLayoutAlign="start">
                <h1 class="hand-count">{{user.hand.length}}</h1>
                <div *ngFor="let card of user.hand" [ngClass]="{'mtg-card-user-container': card.selected}"
                     fxFlex fxLayout="column"
                     (contextmenu)="onRightClick($event, {type: 'hand', card: card, from: user.hand})"
                     (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
                     (click)="toggleCardSelect(card, user.hand)"
                     (cdkDragStarted)="hovered_card=null"
                     cdkDrag>
                  <img [ngClass]="{ 'mtg-card-user-selected': card.selected }" class="mtg-card-user" src="{{card.image}}" alt="{{card.name}}">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="user-deck">
        <div class="zone-data"
             (dblclick)="drawCard(1);"
             (contextmenu)="onRightClick($event, {type: 'deck'})"
             cdkDropList [cdkDropListData]="user.deck"
             cdkDropListOrientation="horizontal"
             (cdkDropListDropped)="moveCardToDeck($event)">
          <h1 class="zone-count">{{user.deck.length}}</h1>
          <img class="mtg-card-user"
               src="https://c1.scryfall.com/file/scryfall-card-backs/large/59/597b79b3-7d77-4261-871a-60dd17403388.jpg?1561757129"
               (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null"
               cdkDrag>
        </div>
      </div>
      <div class="user-grave">
        <div class="zone-data"
             (contextmenu)="onRightClick($event, {type: 'grave'})"
             cdkDropList [cdkDropListData]="user.grave"
             cdkDropListOrientation="horizontal"
             (cdkDropListDropped)="moveCardToGrave($event)">
          <div class="zone-title"><h5>Graveyard</h5></div>
          <h1 class="zone-count">{{user.grave.length}}</h1>
          <div *ngIf="user.grave.length == 0" class="mtg-card-user"></div>
          <img *ngIf="user.grave.length > 0" class="mtg-card-user" src="{{user.grave[0].image}}"
               (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null"
               cdkDrag>
        </div>
      </div>
      <div class="user-exile">
        <div class="zone-data" (contextmenu)="onRightClick($event, {type: 'exile'})"
             cdkDropList [cdkDropListData]="user.exile"
             cdkDropListOrientation="horizontal"
             (cdkDropListDropped)="moveCardToExile($event)">
          <div class="zone-title"><h5>Exile</h5></div>
          <h1 class="zone-count">{{user.exile.length}}</h1>
          <div *ngIf="user.exile.length == 0" class="mtg-card-user"></div>
          <img *ngIf="user.exile.length > 0" class="mtg-card-user" src="{{user.exile[0].image}}"
               (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null"
               cdkDrag>
        </div>
      </div>
      <div class="user-temp-zone">
        <div class="zone-data" (contextmenu)="onRightClick($event, {type: 'temp-zone'})"
             cdkDropList [cdkDropListData]="user.temp_zone"
             cdkDropListOrientation="horizontal"
             (cdkDropListDropped)="moveCardToTempZone($event)">
          <div class="zone-title"><h5>Temp</h5></div>
          <h1 class="zone-count">{{user.temp_zone.length}}</h1>
          <div *ngIf="user.temp_zone.length == 0" class="mtg-card-user"></div>
          <img *ngIf="user.temp_zone.length > 0" class="mtg-card-user" src="{{user.temp_zone[0].image}}"
               (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null"
               cdkDrag>
        </div>
      </div>
      <div class="commander-viewer">
        <div *ngIf="user.commander.length == 1">
          <img class="commander-viewer-single" src="{{user.commander[0].image}}">
        </div>
        <div *ngIf="user.commander.length == 2" class="commander-viewer-partner-holder">
          <img class="commander-viewer-partner-1" src="{{user.commander[0].image}}">
          <img class="commander-viewer-partner-2" src="{{user.commander[1].image}}">
        </div>
      </div>
      <div class="commander-dashboard">
        <div class="commander-dashboard-button-holder">

        </div>
      </div>
      <div class="selected-commander-viewer">
        <img *ngIf="selected_player"
             class="mtg-card-user"
             src="{{selected_player.commander[0].image}}" alt="{{selected_player.commander[0].name}}"
             (pointerenter)="hovered_card=selected_player.commander[0]" (pointerleave)="hovered_card=null">
      </div>
      <div class="selected-player-data">

      </div>
    </div>

  </mat-sidenav-content>
</mat-sidenav-container>


