<div style="visibility: hidden; position: fixed"
     [style.left]="menuTopLeftPosition.x"
     [style.top]="menuTopLeftPosition.y"
     [matMenuTriggerFor]="rightMenu">
</div>

<mat-menu #rightMenu="matMenu">
  <div (click) = "$event.stopPropagation()">
    <ng-template matMenuContent>
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'deck'">
        <div>
          <button mat-button (click)="drawCard(current_draw)">Draw</button>
          <input matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white" [(ngModel)]="current_draw">
        </div>
        <button mat-menu-item>Shuffle</button>
        <button mat-menu-item (click)="drawToActive()">Draw to Active</button>
        <button mat-menu-item (click)="nextTurn()">Next Turn</button>
      </div>
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'hand'">
        <button mat-menu-item>Send to Field</button>
        <button mat-menu-item>Send to Deck</button>
      </div>
    </ng-template>
  </div>
</mat-menu>

<div cdkDropListGroup fxFlexFill (contextmenu)="onRightClick($event, {type: 'none'})">
  <div class="container" fxLayout="row" fxLayoutAlign="center end" fxFlexFill>
    <div fxLayout="column" fxLayoutAlign="start center" fxFlexFill style="margin: 10px;">
      <!-- Opponents -->
      <div class="opponent-holder" fxFlex="100" fxLayout="row" fxLayoutAlign="center center">
        <div class="opponent-playmat-holder" fxLayout="row wrap" fxLayout.lt-md="column" fxLayoutAlign="center">
          <div *ngFor="let player of players">
            <div *ngIf="isOpponent(player)" class="playmat-opponent" [ngClass]="{'playmat-opponent-selected': player.selected}" fxLayout="row wrap" fxLayoutAlign="center center">
              <div *ngFor="let spot of reverse(user_playmat)" class="mtg-card-holder-opponent">
                <div *ngFor="let card of spot; let i = index">
                  <img
                    [ngClass]="
                {
                  'stack-1': i == 0,
                  'stack-2': i == 1,
                  'stack-3': i == 2
                }"
                    [@opponentTappedState]="card.tapped"
                    class="mtg-card-opponent mtg-card-opponent-play"
                    src="{{card.image}}"
                    alt="{{card.name}}"
                    (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- User Playmat -->
      <div fxLayout="row" fxFlex fxLayoutAlign="center">
        <div class="playmat-user" fxLayout="row wrap" fxLayoutAlign="start start">
          <div *ngFor="let spot of user_playmat"
               class="mtg-card-holder-user"
               (dblclick)="tapSpot(spot)"
               cdkDropList
               [cdkDropListData]="spot"
               (cdkDropListDropped)="moveCardToPlay($event)">
            <div *ngFor="let card of spot; let i = index">
              <img [ngClass]="{
              'stack-1': i == 0,
              'stack-2': i == 1,
              'stack-3': i == 2
            }"
                   [@userTappedState]="card.tapped"
                   class="mtg-card-user"
                   src="{{card.image}}"
                   alt="{{card.name}}"
                   (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
                   cdkDrag>
            </div>
          </div>
        </div>
      </div>
      <!-- Opponent Hand -->
      <div fxLayout="row" fxFlex fxLayoutAlign="center">
        <div class="opponent-hand" fxLayout="column" fxLayoutAlign="center">
          <div *ngIf="selected_player != null" class="opponent-hand-list"
               fxFlex fxLayout="row" fxLayoutAlign="start">
            <h1 class="hand-count">{{selected_player.hand.length}}</h1>
            <img *ngFor="let card of selected_player.hand" fxFlex fxLayout="column"
                 class="mtg-card-opponent"
                 src="{{card.image}}" alt="{{card.name}}"
                 (contextmenu)="onRightClick($event, {type: 'opponent_hand', data: card})"
                 (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null">
          </div>
        </div>
      </div>
      <!-- User Hand -->
      <div fxLayout="row" fxFlex fxLayoutAlign="center">
        <div class="user-hand" fxLayout="column" fxLayoutAlign="center">
          <div cdkDropList class="user-hand-list"
               cdkDropListOrientation="horizontal"
               [cdkDropListData]="user.hand"
               (cdkDropListDropped)="moveCardToHand($event)" fxFlex fxLayout="row" fxLayoutAlign="start">
            <h1 class="hand-count">{{user.hand.length}}</h1>
            <img *ngFor="let card of user.hand" fxFlex fxLayout="column"
                 class="mtg-card-user"
                 src="{{card.image}}" alt="{{card.name}}"
                 (contextmenu)="onRightClick($event, {type: 'hand', data: card})"
                 (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
                 cdkDrag>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="user-deck">
    <div class="zone-data"
         (dblclick)="drawCard(1);"
         (contextmenu)="onRightClick($event, {type: 'deck'})"
         cdkDropList [cdkDropListData]="user.deck"
         cdkDropListOrientation="horizontal"
         (cdkDropListDropped)="moveCardToDeck($event)">
      <h1 class="zone-count">{{user.deck.length}}</h1>
      <img class="mtg-card-user" src="https://c1.scryfall.com/file/scryfall-card-backs/large/59/597b79b3-7d77-4261-871a-60dd17403388.jpg?1561757129" (pointerleave)="hovered_card=null" cdkDrag>
    </div>
  </div>
  <div class="user-grave">
    <div class="zone-data"
         (contextmenu)="onRightClick($event, {type: 'grave'})"
         cdkDropList [cdkDropListData]="user.grave"
         cdkDropListOrientation="horizontal" cdk
         (cdkDropListDropped)="moveCardToGrave($event)">
      <h1 class="zone-count">{{user.grave.length}}</h1>
      <div *ngIf="user.grave.length == 0" class="mtg-card-user"></div>
      <img *ngIf="user.grave.length > 0" class="mtg-card-user" src="{{user.grave[0].image}}"
           (pointerleave)="hovered_card=null" cdkDrag>
    </div>
  </div>
  <div class="user-exile">
    <div class="zone-data" (contextmenu)="onRightClick($event, {type: 'exile'})"
         cdkDropList [cdkDropListData]="user.exile"
         cdkDropListOrientation="horizontal"
         (cdkDropListDropped)="moveCardToExile($event)">
      <h1 class="zone-count">{{user.exile.length}}</h1>
      <div *ngIf="user.exile.length == 0" class="mtg-card-user"></div>
      <img *ngIf="user.exile.length > 0" class="mtg-card-user" src="{{user.exile[0].image}}"
           (pointerleave)="hovered_card=null" cdkDrag>

    </div>
  </div>
  <div class="card-preview" *ngIf="hovered_card">
    <div fxLayout="row" fxLayoutAlign="start start" fxFlex="100">
      <div fxLayout="column" fxLayoutAlign="start center" fxFlex="100">
        <img class="mtg-card-preview" src="{{hovered_card.image}}" alt="{{hovered_card.name}}">
        <h5 style="text-align: center">{{hovered_card.mana}}</h5>
        <h5 style="margin: 10px; white-space: pre-line">{{hovered_card.text}}</h5>
      </div>
    </div>
  </div>
  <div class="player-list">
    <mat-list>
      <mat-divider></mat-divider>
      <div *ngFor="let player of players; let j = index">
        <mat-list-item [ngClass]="{'player-button-selected': player.selected,
                                  'player-button-turn': player.turn == current_turn}">
          <div fxLayout="row" fxLayoutAlign="space-between center" fxFlexFill>
            <div fxLayout="column" fxFlex="100">
              <button class="player-button" mat-button (click)="selectPlayer(player)">
                {{player.name}}
              </button>
            </div>
            <div fxLayout="column" fxFlex="100">
              <div fxLayout="row" fxFlex>
                <div class="column" fxFlex>
                  <button *ngIf="isOpponent(player)" class="player-button" mat-button disabled style="color: white">
                    {{player.life}}
                  </button>
                  <button *ngIf="!isOpponent(player)" class="player-button" mat-button
                          (click)="player.life = player.life + 1" (contextmenu)="onRightClick($event, {type: 'life', player: player})">
                    {{player.life}}
                  </button>
                </div>
                <div class="column" fxFlex>
                  <button *ngIf="isOpponent(player)" class="player-button" mat-button disabled style="color: white">
                    {{player.infect}}
                  </button>
                  <button *ngIf="!isOpponent(player)" class="player-button" mat-button
                          (click)="player.infect = player.infect + 1" (contextmenu)="onRightClick($event, {type: 'infect', player: player})">
                    {{player.infect}}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </mat-list-item>
        <mat-divider *ngIf="j != players.length - 1"></mat-divider>
      </div>
    </mat-list>
  </div>
</div>

