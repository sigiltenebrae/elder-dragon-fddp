<div style="visibility: hidden; position: fixed"
     [style.left]="menuTopLeftPosition.x"
     [style.top]="menuTopLeftPosition.y"
     [matMenuTriggerFor]="rightMenu">
</div>

<div *ngIf="user != null" class="counter-creator" fxLayout="column">
  <div class="counter-container">
    <button class="counter-creator-button" mat-fab (click)="createCounter()"><mat-icon>add</mat-icon></button>
    <!--<button cdkDrag mat-fab (click)="counter.value = counter.value + 1"
            (contextmenu)="onRightClick($event, {type: 'custom_counter', counter: counter})"
            (keyup.escape)="deleteCounter(counter)"
            *ngFor="let counter of user.counters" style="background: {{counter.color}}">{{counter.value}}</button>-->
    <mat-card *ngFor="let counter of user.counters" class="commander-dashboard-custom-counter"
              style="padding: 0" cdkDrag>

        <!--<div fxLayout="row" fxLayoutAlign="end">

&lt;!&ndash;          <h2 style="margin: 0 5px 5px 5px; padding: 0;">In Play: {{typeCount(user, custom_search.value)}} </h2>&ndash;&gt;
        </div>-->
      <mat-form-field appearance="fill" class="commander-dashboard-input">
        <mat-label>Enter a Type</mat-label>
        <input #custom_search matInput>
      </mat-form-field>
      <div fxFlex="100" fxLayout="row" fxLayoutGap="10" class="commander-dashboard-select-holder" fxLayoutAlign="space-between">
        <mat-form-field appearance="outline" class="commander-dashboard-select">
          <mat-label>Player</mat-label>
          <mat-select #search_player>
            <mat-option *ngFor="let player of players" [value]="player">{{player.name}}</mat-option>
            <mat-option [value]="'All'">All</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="commander-dashboard-select">
          <mat-label>Player</mat-label>
          <mat-select #search_zone>
            <mat-option [value]="'Play'">Play</mat-option>
            <mat-option [value]="'Grave'">Graveyard</mat-option>
            <mat-option [value]="'Exile'">Exile</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <h1 class="commander-dashboard-text" style="text-align: end">Count: {{typeCount(search_player.value, search_zone.value,  custom_search.value)}}</h1>
    </mat-card>
  </div>
</div>

<mat-menu #rightMenu="matMenu">
  <div>
    <ng-template matMenuContent>
      <button mat-menu-item (click)="untapAll()">Untap All</button>
      <!-- Deck -->
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'deck'">
        <div>
          <button mat-button>Draw</button>
          <input (click)="$event.stopPropagation()" matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white">
        </div>
        <div>
          <button mat-button (click)="scryX(scry_val.value)">Scry</button>
          <input (click)="$event.stopPropagation()" matInput #scry_val type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white">
        </div>
        <div>
          <button mat-button>Draw to Play</button>
          <input (click)="$event.stopPropagation()" matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white">
        </div>
        <div>
          <button mat-button>Draw to Grave</button>
          <input (click)="$event.stopPropagation()" matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white">
        </div>
        <div>
          <button mat-button>Draw to Exile</button>
          <input (click)="$event.stopPropagation()" matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white">
        </div>
        <div>
          <button mat-button>Draw to Temp</button>
          <input (click)="$event.stopPropagation()" matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white">
        </div>
        <div>
          <button mat-button>Send to Selected</button>
          <input (click)="$event.stopPropagation()" matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white">
        </div>
        <button mat-menu-item (click)="openSideNav('deck')">Search Deck</button>
        <button mat-menu-item (click)="drawUntil('Creature')">Draw Until Creature</button>
        <div>
          <button mat-button (click)="cascade(cascade_count.value)">Cascade</button>
          <input (click)="$event.stopPropagation()" #cascade_count matInput type="number" style="width: 40px; margin: 2px; background: rgba(0,0,0,0); border: none; color: white">
        </div>
        <button mat-menu-item (click)="shuffleDeck(user.deck.cards)">Shuffle</button>
        <button mat-menu-item (click)="openTokenDialog()">Create Token</button>
        <button mat-menu-item (click)="nextTurn()">Next Turn</button>
        <button mat-menu-item (click)="togglePreview()">Toggle Preview</button>
        <button mat-menu-item (click)="hidden=!hidden">Toggle Hidden</button>
      </div>
      <!-- Hand -->
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'hand'">
        <button mat-menu-item>Send to Play</button>
        <button mat-menu-item>Send to Grave</button>
        <button mat-menu-item>Send to Exile</button>
        <button mat-menu-item>Send to Deck Top</button>
        <button mat-menu-item>Send to Deck Bottom</button>
        <button mat-menu-item>Send to Temp</button>
        <button mat-menu-item>Send to Selected</button>
      </div>
      <!-- inPlayUser -->
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'inPlayUser'">
        <button mat-menu-item (click)="tapSpot(rightclicked_item.spot)">(un)Tap Stack</button>
        <button mat-menu-item (click)="sendCardToZone(rightclicked_item.card, rightclicked_item.spot, 'hand')">Send to Hand</button>
        <button mat-menu-item (click)="sendCardToZone(rightclicked_item.card, rightclicked_item.spot, 'grave')">Send to Grave</button>
        <button mat-menu-item (click)="sendCardToZone(rightclicked_item.card, rightclicked_item.spot, 'exile')">Send to Exile</button>
        <button mat-menu-item (click)="sendCardToZone(rightclicked_item.card, rightclicked_item.spot, 'temp_zone')">Send to Temp</button>
        <button mat-menu-item (click)="sendCardToZone(rightclicked_item.card, rightclicked_item.spot, 'selected')">Send to Selected</button>
        <button mat-menu-item (click)="sendCardToZone(rightclicked_item.card, rightclicked_item.spot, 'deck_top')">Send to Deck Top</button>
        <button mat-menu-item (click)="sendCardToZone(rightclicked_item.card, rightclicked_item.spot, 'deck_bottom')">Send to Deck Bottom</button>
        <button mat-menu-item (click)="rightclicked_item.card.counter_1 = !rightclicked_item.card.counter_1; rightclicked_item.card.counter_1_value=0">Toggle Counter 1</button>
        <button mat-menu-item (click)="rightclicked_item.card.counter_2 = !rightclicked_item.card.counter_2; rightclicked_item.card.counter_2_value=0">Toggle Counter 2</button>
        <button mat-menu-item (click)="rightclicked_item.card.counter_3 = !rightclicked_item.card.counter_3; rightclicked_item.card.counter_3_value=0">Toggle Counter 3</button>
        <button mat-menu-item (click)="rightclicked_item.card.multiplier = !rightclicked_item.card.multiplier; rightclicked_item.card.multiplier_value=0">Toggle Multiplier</button>
        <button *ngIf="rightclicked_item.card.back_face" mat-menu-item (click)="altFaceCard(rightclicked_item.card)">Alt Face</button>
        <button mat-menu-item (click)="cloneCard(rightclicked_item.card)">Clone</button>
        <button mat-menu-item (click)="rightclicked_item.card.locked = !rightclicked_item.card.locked;">Lock Card</button>
        <button *ngFor="let token of rightclicked_item.card.tokens" mat-menu-item (click)="createToken(token)">Create {{token.name}} Token</button>
      </div>
      <!-- Grave -->
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'grave'">
        <button mat-menu-item (click)="openSideNav('grave')">View Graveyards</button>
      </div>
      <!-- Exile -->
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'exile'">
        <button mat-menu-item (click)="openSideNav('exile')">View Exiles</button>
      </div>
      <!-- Temp Zone -->
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'temp-zone'">
        <button mat-menu-item (click)="openSideNav('temp_zone')">View Temp Zones</button>
      </div>
      <!-- Sidenav -->
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'sidenav'">
        <button mat-menu-item>Send to Play</button>
        <button mat-menu-item>Send to Grave</button>
        <button mat-menu-item>Send to Exile</button>
        <button mat-menu-item>Send to Deck Top</button>
        <button mat-menu-item>Send to Deck Bottom</button>
        <button mat-menu-item>Send to Hand</button>
        <button mat-menu-item>Send to Temp</button>
        <button mat-menu-item>Send to Selected</button>
      </div>
      <!-- Commander (command zone) -->
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'commander'">
        <button mat-menu-item (click)="openDeckSelectDialog()">Change Deck</button>
        <button mat-menu-item (click)="castCommander(rightclicked_item.card)">Cast Commander</button>
        <button *ngIf="user.deck.commander_saved.length == 2" mat-menu-item (click)="swapCommanders()">Swap Commanders</button>
        <button mat-menu-item (click)="selectAllBlank('Creature')">Select All Creatures</button>
        <button mat-menu-item (click)="openTokenDialog()">Create Token</button>
      </div>
      <!-- Scry -->
      <div *ngIf="rightclicked_item.type && rightclicked_item.type === 'scry'">
        <button mat-menu-item (click)="scrySendTo(rightclicked_item.card, 'top')">Send to Deck Top</button>
        <button mat-menu-item (click)="scrySendTo(rightclicked_item.card, 'bottom')">Send to Deck Bottom</button>
        <button mat-menu-item (click)="scrySendTo(rightclicked_item.card, 'temp_zone')">Send to Temp Zone</button>
      </div>
    </ng-template>
  </div>
</mat-menu>

<div class="fddp-hover-holder" [style.display]="hovered_card || preview ? 'block': 'none'" [style.pointer-events]="preview ? 'all': 'none'">
  <mat-card class="fddp-hover-box" cdkDrag [cdkDragFreeDragPosition]="hoverdata.position">
    <div *ngIf="hovered_card">
      <img *ngIf="!hoverdata.shift_pressed && (!hoverdata.control_pressed || !hovered_card.back_face)" src="{{hovered_card.image}}" class="fddp-hover-image">
      <img *ngIf="!hoverdata.shift_pressed && hoverdata.control_pressed && hovered_card.back_face" src="{{hovered_card.back_image}}" class="fddp-hover-image">
      <div *ngIf="hoverdata.shift_pressed && (!hoverdata.control_pressed || !hovered_card.back_face)" fxFlexFill fxLayout="row" fxLayoutAlign="center center">
        <div fxLayout="column" fxLayoutAlign="center center" fxFlex>
          <div style="text-align: center">
            <h3 *ngIf="hovered_card.name" style="margin: 2px">{{hovered_card.name}}</h3>
            <h3 style="margin: 2px" *ngIf="hovered_card.is_token && !hovered_card.types.includes('Token')">(Copy)</h3>
            <h3 style="margin: 2px" *ngIf="hovered_card.is_token && hovered_card.types.includes('Token')">(Token)</h3>
            <mat-divider></mat-divider>
            <h3 *ngIf="hovered_card.mana_cost" style="margin: 2px">{{hovered_card.mana_cost.join(' ')}}</h3>
            <h3 *ngIf="hovered_card.types" style="margin: 2px">{{hovered_card.types.join(' ')}}</h3>
            <mat-divider></mat-divider>
            <h3 *ngIf="hovered_card.oracle_text" style="margin: 10px; white-space: pre-line">{{hovered_card.oracle_text}}</h3>
            <h3 *ngIf="hovered_card.power && hovered_card.power != null && hovered_card.toughness && hovered_card.toughness != null">
              {{hovered_card.power}}/{{hovered_card.toughness}}
            </h3>
            <h3 *ngIf="hovered_card.loyalty && hovered_card.loyalty !== null">{{hovered_card.loyalty}}</h3>
          </div>
        </div>
      </div>

      <div *ngIf="hoverdata.shift_pressed && hoverdata.control_pressed && hovered_card.back_face" fxFlexFill fxLayout="row" fxLayoutAlign="center center">
        <div fxLayout="column" fxLayoutAlign="center center">
          <div style="text-align: center">
            <h3 style="margin: 2px">{{hovered_card.name}}</h3>
            <mat-divider></mat-divider>
            <h3 style="margin: 2px">{{hovered_card.back_mana_cost.join(' ')}}</h3>
            <h3 style="margin: 2px">{{hovered_card.back_types.join(' ')}}</h3>
            <mat-divider></mat-divider>
            <h3 style="margin: 10px; white-space: pre-line">{{hovered_card.back_oracle_text}}</h3>
            <h3 *ngIf="hovered_card.back_power && hovered_card.back_power != null && hovered_card.back_toughness && hovered_card.back_toughness != null">
              {{hovered_card.back_power}}/{{hovered_card.back_toughness}}
            </h3>
            <h3 *ngIf="hovered_card.back_loyalty && hovered_card.back_loyalty !== null">{{hovered_card.back_loyalty}}</h3>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="preview" class="fddp-hover-handle" cdkDragHandle>
      <mat-icon>open_with</mat-icon>
    </div>
    <div *ngIf="preview" class="fddp-hover-minimize">
      <mat-icon (click)="togglePreview()">minimize</mat-icon>
    </div>
  </mat-card>
</div>

<div *ngIf="scrying" class="scrydata-holder">
  <div fxFlexFill fxLayout="row" fxLayoutAlign="center center">
    <mat-card fxFlex="70" class="scrydata-card-holder" fxLayout="column" fxLayoutAlign="start center">
      <div fxLayout="row" fxLayoutAlign="center">
        <h2>Scrying</h2>
      </div>

      <div fxLayout="row wrap" fxLayoutAlign="center start">
        <div *ngFor="let card of temp_scry_zone; let i = index" class="scrydata-card-container">
          <img class="scrydata-card" src="{{card.image}}"
               [ngClass]="{'mtg-card-user-selected': card.selected}"
               (click)="toggleCardSelect(card, temp_scry_zone);"
               (contextmenu)="onRightClick($event,{type: 'scry', card: card});">
          <h1 class="scrydata-card-count">{{i + 1}}</h1>
        </div>
      </div>
      <div class="scrydata-card-close">
        <mat-icon (click)="endScry()">close</mat-icon>
      </div>
    </mat-card>
  </div>
</div>

<mat-sidenav-container fxFlexFill cdkDropListGroup hasBackdrop="false" *ngIf="!loading">
  <mat-sidenav #fddp_sidenav disableClose>
    <mat-toolbar color="primary">
      <div fxFlex="100" fxLayout="row" fxLayoutAlign="space-between center">
        <h2 fxFlex *ngIf="sidenav_type==='grave'">Graveyards</h2>
        <h2 fxFlex *ngIf="sidenav_type==='exile'">Exile</h2>
        <h2 fxFlex *ngIf="sidenav_type==='temp_zone'">Temp Zones</h2>
        <h2 fxFlex *ngIf="sidenav_type==='deck'">Searching Deck</h2>
        <button mat-icon-button (click)="closeSideNav()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </mat-toolbar>
    <div *ngIf="sidenav_type === 'grave'">
      <div fxLayout="column">
        <mat-form-field appearance="outline" fxFlex style="margin: 5px;">
          <mat-label>Player</mat-label>
          <mat-select [(ngModel)]="sidenav_selected_player" name="player_select_sidenav" (ngModelChange)="updateSidenav()">
            <mat-option *ngFor="let player of players" [value]="player">
              {{player.name}}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field fxFlex style="margin: 5px;" appearance="outline">
          <mat-label>Search</mat-label>
          <input type="text" placeholder="Card Name"
                 matInput [matAutocomplete]="card_name"
                 [(ngModel)]="sidenav_sort" (ngModelChange)="getSidenavSort(sidenav_selected_player.grave)">
          <mat-autocomplete #card_name>
            <mat-option *ngFor="let card of sidenav_selected_player.grave" [value]="card.name">
              {{card.name}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <div class="sidenav-list" cdkDropList
             (cdkDropListDropped)="moveCardToZone($event, 'grave', true)"
             [cdkDropListData]="sidenav_selected_player.grave">
          <div *ngFor="let card of sidenav_selected_player.grave"
               class="sidenav-list-item"
               [ngClass]="{'sidenav-list-item-selected': card.selected}"
               (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null; selectCard(card, sidenav_selected_player.grave);"
               (click)="toggleCardSelect(card, sidenav_selected_player.grave, card.sidenav_visible)"
               [cdkDragDisabled]="!card.sidenav_visible" (contextmenu)="onRightClick($event, {type: 'sidenav_grave', card: card, from: sidenav_selected_player.grave})"
               cdkDrag>
            {{card.name}}
            <img *cdkDragPreview [src]="card.image" [alt]="card.name" class="mtg-card-user" loading="lazy">
            <img *cdkDragPlaceholder class="mtg-card-user" [src]="card.image" [alt]="card.name" loading="lazy">
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="sidenav_type === 'exile'">
      <div fxLayout="column">
        <mat-form-field appearance="outline" fxFlex style="margin: 5px;">
          <mat-label>Player</mat-label>
          <mat-select [(ngModel)]="sidenav_selected_player" name="player_select_sidenav" (ngModelChange)="updateSidenav()">
            <mat-option *ngFor="let player of players" [value]="player">
              {{player.name}}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field fxFlex style="margin: 5px;" appearance="outline">
          <mat-label>Search</mat-label>
          <input type="text" placeholder="Card Name"
                 matInput [matAutocomplete]="card_name"
                 [(ngModel)]="sidenav_sort" (ngModelChange)="getSidenavSort(sidenav_selected_player.exile)">
          <mat-autocomplete #card_name>
            <mat-option *ngFor="let card of sidenav_selected_player.exile" [value]="card.name">
              {{card.name}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <div class="sidenav-list" cdkDropList
             (cdkDropListDropped)="moveCardToZone($event, 'exile', true)"
             [cdkDropListData]="sidenav_selected_player.exile">
          <div *ngFor="let card of sidenav_selected_player.exile"
               class="sidenav-list-item"
               [ngClass]="{'sidenav-list-item-selected': card.selected}"
               (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null; selectCard(card, sidenav_selected_player.exile);"
               (click)="toggleCardSelect(card, sidenav_selected_player.exile, card.sidenav_visible)"
               (contextmenu)="onRightClick($event, {type: 'sidenav_exile', card: card, from: sidenav_selected_player.exile})"
               [cdkDragDisabled]="!card.sidenav_visible"
               cdkDrag>
            {{card.name}}
            <img *cdkDragPreview [src]="card.image" [alt]="card.name" class="mtg-card-user" loading="lazy">
            <img *cdkDragPlaceholder class="mtg-card-user" [src]="card.image" [alt]="card.name" loading="lazy">
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="sidenav_type === 'temp_zone'">
      <div fxLayout="column">
        <mat-form-field appearance="outline" fxFlex style="margin: 5px;">
          <mat-label>Player</mat-label>
          <mat-select [(ngModel)]="sidenav_selected_player" name="player_select_sidenav" (ngModelChange)="updateSidenav()">
            <mat-option *ngFor="let player of players" [value]="player">
              {{player.name}}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field fxFlex style="margin: 5px;" appearance="outline">
          <mat-label>Search</mat-label>
          <input type="text" placeholder="Card Name"
                 matInput [matAutocomplete]="card_name"
                 [(ngModel)]="sidenav_sort" (ngModelChange)="getSidenavSort(sidenav_selected_player.temp_zone)">
          <mat-autocomplete #card_name>
            <mat-option *ngFor="let card of sidenav_selected_player.temp_zone" [value]="card.name">
              {{card.name}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <div class="sidenav-list" cdkDropList
             (cdkDropListDropped)="moveCardToZone($event, 'temp_zone', true)"
             [cdkDropListData]="sidenav_selected_player.temp_zone">
          <div *ngFor="let card of sidenav_selected_player.temp_zone"
               class="sidenav-list-item"
               [ngClass]="{'sidenav-list-item-selected': card.selected}"
               (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
               (cdkDragStarted)="hovered_card=null; selectCard(card, sidenav_selected_player.temp_zone);"
               (click)="toggleCardSelect(card, sidenav_selected_player.temp_zone, card.sidenav_visible)"
               (contextmenu)="onRightClick($event, {type: 'sidenav_temp_zone', card: card, from: sidenav_selected_player.temp_zone})"
               [cdkDragDisabled]="!card.sidenav_visible"
               cdkDrag>
            {{card.name}}
            <img *cdkDragPreview [src]="card.image" [alt]="card.name" class="mtg-card-user" loading="lazy">
            <img *cdkDragPlaceholder class="mtg-card-user" [src]="card.image" [alt]="card.name" loading="lazy">
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="sidenav_type === 'deck'">
      <div fxLayout="column">
        <mat-form-field fxFlex style="margin: 5px;" appearance="outline">
          <mat-label>Search</mat-label>
          <input type="text" placeholder="Card Name"
                 matInput [matAutocomplete]="card_name"
                 [(ngModel)]="sidenav_sort" (ngModelChange)="getSidenavSort(sidenav_selected_player.deck.cards)">
          <mat-autocomplete #card_name>
            <mat-option *ngFor="let card of sidenav_selected_player.deck.cards" [value]="card.name">
              {{card.name}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <div class="sidenav-list" cdkDropList
             (cdkDropListDropped)="moveCardToZone($event, 'deck', true)"
             [cdkDropListData]="sidenav_selected_player.deck.cards">
          <div *ngFor="let card of sidenav_selected_player.deck.cards; let c = index">
            <div *ngIf="(sidenav_type === 'deck' && card.sidenav_visible)" class="sidenav-list-item"
              [ngClass]="{'sidenav-list-item-selected': card.selected}"
              (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
              (cdkDragStarted)="hovered_card=null; selectCard(card, sidenav_selected_player.deck.cards);"
              (click)="toggleCardSelect(card, sidenav_selected_player.deck.cards, card.sidenav_visible)"
              (contextmenu)="onRightClick($event, {type: 'sidenav_deck', card: card, from: sidenav_selected_player.deck.cards})"
              cdkDrag>
              {{card.name}}
              <img *cdkDragPreview [src]="card.image" [alt]="card.name" class="mtg-card-user" loading="lazy">
              <img *cdkDragPlaceholder class="mtg-card-user" [src]="card.image" [alt]="card.name" loading="lazy">
            </div>
          </div>
        </div>
      </div>
    </div>
  </mat-sidenav>
  <mat-sidenav-content>
      <div class="player-list">
        <mat-card style="padding:5px 10px 0 0">
          <mat-list>
            <mat-divider></mat-divider>
            <div *ngFor="let player of players; let j = index">
              <mat-list-item [ngClass]="{'player-button-selected': player.selected,
                                  'player-button-turn': player.turn == current_turn}">
                <div fxLayout="row" fxLayoutAlign="space-between center" fxFlexFill>
                  <div fxLayout="column" fxFlex="100">
                    <button (pointerenter)="hovered_card=isOpponent(player) ? player.deck.commander[0]: null" (pointerleave)="hovered_card=null"
                      class="player-button"
                      mat-button
                      (click)="selectPlayer(player)">
                      {{player.name}}
                    </button>
                  </div>
                  <div fxLayout="column" fxFlex="100">
                    <div fxLayout="row" fxFlex>
                      <div class="column" fxFlex>
                        <button (pointerenter)="hovered_card=player.deck.commander.length>1 ? player.deck.commander[1] : null" (pointerleave)="hovered_card=null" *ngIf="isOpponent(player)" class="player-button" mat-button disabled style="color: white">
                          {{player.life}}
                        </button>
                        <button *ngIf="!isOpponent(player)" class="player-button" mat-button
                                (click)="player.life = player.life + 1" (contextmenu)="onRightClick($event, {type: 'life', player: player})">
                          {{player.life}}
                        </button>
                      </div>
                      <div class="column" fxFlex>
                        <button *ngIf="isOpponent(player)" class="player-button" mat-button disabled style="color: white">
                          {{player.infect}}
                        </button>
                        <button *ngIf="!isOpponent(player)" class="player-button" mat-button
                                (click)="player.infect = player.infect + 1" (contextmenu)="onRightClick($event, {type: 'infect', player: player})">
                          {{player.infect}}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-list-item>
              <mat-divider *ngIf="j != players.length - 1"></mat-divider>
            </div>
          </mat-list>
        </mat-card>
      </div>
      <div fxFlexFill (contextmenu)="onRightClick($event, {type: 'none'})">
        <div class="container" fxLayout="row" fxLayoutAlign="center end" fxFlexFill>
          <div fxLayout="column" fxLayoutAlign="start center" fxFlexFill style="margin: 10px;">
            <!-- &&Opponents -->
            <div class="opponent-holder" fxFlex="100" fxLayout="row" fxLayoutAlign="center center">
              <div class="opponent-playmat-holder" fxLayout="row wrap" fxLayout.lt-md="column" fxLayoutAlign="center">
                <div *ngFor="let player of players">
                  <mat-card *ngIf="isOpponent(player)" class="playmat-opponent" fxLayout="row wrap" fxLayoutAlign="center center">
                    <div class="playmat-opponent-data">
                      <div class="opponent-information">
                        <h3>Hand: {{player.hand.length}}, Deck: {{player.deck.cards.length}}, Graveyard: {{player.grave.length}}, Exile: {{player.exile.length}}</h3>
                      </div>
                      <div class="playmat-opponent-selector" [ngClass]="{'playmat-opponent-selected': player.selected}"></div>
                      <div class="playmat-opponent-card-data">
                        <div *ngFor="let spot of reversePlaymat(player.playmat)" class="mtg-card-holder-opponent">
                          <div *ngFor="let card of spot; let i = index">
                            <div [ngClass]="{'stack-1': i == 0,'stack-2': i == 1,'stack-3': i == 2}" class="mtg-card-opponent-container"
                                 (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null" [@opponentTappedState]="card.tapped">
                              <img class="mtg-card-opponent" src="{{card.image}}" alt="{{card.name}}" loading="lazy">

                              <button *ngIf="card.counter_1" class="mtg-counter-1" mat-fab color="primary" [class.mat-elevation-z8]="true"><p>{{card.counter_1_value}}</p></button>
                              <button *ngIf="card.counter_2" class="mtg-counter-2" mat-fab color="accent" [class.mat-elevation-z8]="true"><p>{{card.counter_2_value}}</p></button>
                              <button *ngIf="card.counter_3" class="mtg-counter-3" mat-fab color="warn" [class.mat-elevation-z8]="true"><p>{{card.counter_3_value}}</p></button>
                              <button *ngIf="card.multiplier" class="mtg-multiplier-counter" mat-fab color="accent" [class.mat-elevation-z8]="true"><p>{{card.multiplier_value}}</p></button>

                              <h5 *ngIf="card.power && card.toughness && card.power != null && card.toughness != null" class="mtg-card-power-tough">
                                <a [ngClass]="{'mat-card-power-tough-text-up': card.power_mod > 0, 'mat-card-power-tough-text-down': card.power_mod < 0}" class="mat-card-power-tough-text">{{card.power + card.power_mod}}</a>/
                                <a [ngClass]="{'mat-card-power-tough-text-up': card.toughness_mod > 0, 'mat-card-power-tough-text-down': card.toughness_mod < 0}" class="mat-card-power-tough-text">{{card.toughness + card.toughness_mod}}</a></h5>
                              <h5 *ngIf="card.loyalty && card.loyalty != null" class="mtg-card-loyalty"><a class="mat-card-power-tough-text" [ngClass]="{'mat-card-power-tough-text-up': card.loyalty_mod > 0, 'mat-card-power-tough-text-down': card.loyalty_mod < 0}">{{card.loyalty + card.loyalty_mod}}</a></h5>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </mat-card>
                </div>
              </div>
            </div>
            <!-- &&Playmat User -->
            <div fxLayout="row" fxFlex fxLayoutAlign="center">
              <div class="playmat-user-holder">
                <div class="playmat-user-devotions" >
                  <div fxFlexFill fxLayout="column" fxLayoutAlign="space-evenly start">
                    <div class="devotion-holder">
                      <button mat-fab class="devotion-white">{{devotionCount(user, 'W')}}</button>
                    </div>
                    <div class="devotion-holder">
                      <button mat-fab class="devotion-blue">{{devotionCount(user, 'U')}}</button>
                    </div>
                    <div class="devotion-holder">
                      <button mat-fab class="devotion-black">{{devotionCount(user, 'B')}}</button>
                    </div>
                    <div class="devotion-holder">
                      <button mat-fab class="devotion-red">{{devotionCount(user, 'R')}}</button>
                    </div>
                    <div class="devotion-holder">
                      <button mat-fab class="devotion-green">{{devotionCount(user, 'G')}}</button>
                    </div>
                  </div>
                </div>
                <mat-card class="playmat-user" fxLayout="row wrap" fxLayoutAlign="start start">
                  <div *ngFor="let spot of user.playmat"
                       class="mtg-card-holder-user"
                       cdkDropList
                       [cdkDropListData]="spot"
                       (cdkDropListDropped)="moveCardToZone($event, 'play')"
                        (dblclick)="sendSelectedToSpot(spot, 'play')">
                    <div *ngFor="let card of spot; let i = index">
                      <mat-card [ngClass]="{'stack-1': i == 0, 'stack-2': i == 1, 'stack-3': i == 2}"
                           (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
                           (cdkDragStarted)="hovered_card=null; selectCard(card, spot);"
                           class="mtg-card-user-container" [@userTappedState]="card.tapped"
                           cdkDrag>
                        <div *ngIf="card.locked" class="mtg-lock"><mat-icon>lock</mat-icon></div>
                        <img [ngClass]="{'mtg-card-user-selected': card.selected, 'mtg-card-clone': card.is_token && !card.types.includes('Token') }"
                             class="mtg-card-user"
                             src="{{card.image}}"
                             alt="{{card.name}}"
                             (contextmenu)="onRightClick($event,{type: 'inPlayUser', card: card, spot: spot}); selectCard(card, spot);"
                             (click)="toggleCardSelect(card, spot)" (dblclick)="tapCard(card)" loading="lazy">
                        <button *ngIf="card.counter_1" class="mtg-counter-1" mat-fab color="primary" [class.mat-elevation-z8]="true" (click)="card.counter_1_value = card.counter_1_value + 1" (contextmenu)="onRightClick($event, {type: 'counter_1', card: card})"><p>{{card.counter_1_value}}</p></button>
                        <button *ngIf="card.counter_2" class="mtg-counter-2" mat-fab color="accent" [class.mat-elevation-z8]="true" (click)="card.counter_2_value = card.counter_2_value + 1" (contextmenu)="onRightClick($event, {type: 'counter_2', card: card})"><p>{{card.counter_2_value}}</p></button>
                        <button *ngIf="card.counter_3" class="mtg-counter-3" mat-fab color="warn" [class.mat-elevation-z8]="true" (click)="card.counter_3_value = card.counter_3_value + 1" (contextmenu)="onRightClick($event, {type: 'counter_3', card: card})"><p>{{card.counter_3_value}}</p></button>
                        <button *ngIf="card.multiplier" class="mtg-multiplier-counter" mat-fab color="accent" [class.mat-elevation-z8]="true" (click)="card.multiplier_value = card.multiplier_value + 1" (contextmenu)="onRightClick($event, {type: 'multiplier', card: card})"><p>{{card.multiplier_value}}</p></button>
                        <h4 *ngIf="card.power && card.toughness" class="mtg-card-power-tough">
                          <a [ngClass]="{'mat-card-power-tough-text-up': card.power_mod > 0, 'mat-card-power-tough-text-down': card.power_mod < 0}" class="mat-card-power-tough-text" (click)="card.power_mod = card.power_mod + 1" (contextmenu)="onRightClick($event, {type: 'power', card: card})">{{card.power + card.power_mod}}</a>/
                          <a [ngClass]="{'mat-card-power-tough-text-up': card.toughness_mod > 0, 'mat-card-power-tough-text-down': card.toughness_mod < 0}" class="mat-card-power-tough-text" (click)="card.toughness_mod = card.toughness_mod + 1" (contextmenu)="onRightClick($event, {type: 'toughness', card: card})">{{card.toughness + card.toughness_mod}}</a></h4>
                        <h4 *ngIf="card.loyalty" class="mtg-card-loyalty"><a class="mat-card-power-tough-text" [ngClass]="{'mat-card-power-tough-text-up': card.loyalty_mod > 0, 'mat-card-power-tough-text-down': card.loyalty_mod < 0}" (click)="card.loyalty_mod = card.loyalty_mod + 1" (contextmenu)="onRightClick($event, {type: 'loyalty', card: card})">{{card.loyalty + card.loyalty_mod}}</a></h4>
                      </mat-card>

                    </div>
                  </div>
                </mat-card>
              </div>
            </div>
            <!-- Opponent Hand -->
            <div fxLayout="row" fxFlex fxLayoutAlign="center">
              <div class="opponent-hand" fxLayout="column" fxLayoutAlign="center" [class.mat-elevation-z8]="selected_player != null">
                <div *ngIf="selected_player != null" class="opponent-hand-list"
                     fxFlex fxLayout="row" fxLayoutAlign="start">
                  <h1 class="hand-count">{{selected_player.hand.length}}</h1>
                  <img *ngFor="let card of selected_player.hand" fxFlex fxLayout="column"
                       class="mtg-card-opponent"
                       src="{{canSee(card, user) ? card.image: selected_player.deck.sleeves}}" alt="card"
                       (contextmenu)="onRightClick($event, {type: 'opponent_hand', card: card})"
                       (pointerenter)="hovered_card = canSee(card, user)? card: null" (pointerleave)="hovered_card=null" loading="lazy">
                </div>
              </div>
            </div>
            <!-- User Hand -->
            <div fxLayout="row" fxFlex fxLayoutAlign="center">
              <div class="user-hand" fxLayout="column" fxLayoutAlign="center" [class.mat-elevation-z8]="true">
                <div cdkDropList class="user-hand-list"
                     cdkDropListOrientation="horizontal"
                     [cdkDropListData]="user.hand"
                     (cdkDropListDropped)="moveCardToZone($event, 'hand')" fxFlexFill fxLayout="row" fxLayoutAlign="start">
                  <h1 class="hand-count">{{user.hand.length}}</h1>
                  <mat-icon class="hand-menu">menu</mat-icon>
                  <mat-card *ngFor="let card of user.hand" class="mtg-card-user-container"
                       fxFlex fxLayout="column"
                       (contextmenu)="onRightClick($event, {type: 'hand', card: card, from: user.hand})"
                       (pointerenter)="hovered_card=card" (pointerleave)="hovered_card=null"
                       (click)="toggleCardSelect(card, user.hand)"
                       (cdkDragStarted)="hovered_card=null; selectCard(card, user.hand);"
                       cdkDrag>
                    <img [ngClass]="{ 'mtg-card-user-selected': card.selected }" class="mtg-card-user" src="{{card.image}}" alt="{{card.name}}" loading="lazy">
                  </mat-card>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="user-deck">
          <mat-card class="zone-data"
               (dblclick)="drawX(1)"
               (contextmenu)="onRightClick($event, {type: 'deck'})"
               cdkDropList [cdkDropListData]="user.deck.cards"
               cdkDropListOrientation="horizontal"
               (cdkDropListDropped)="moveCardToZone($event, 'deck')">
            <h1 class="zone-count">{{user.deck.cards.length}}</h1>
            <img class="mtg-card-user"
                 src="https://c1.scryfall.com/file/scryfall-card-backs/large/59/597b79b3-7d77-4261-871a-60dd17403388.jpg?1561757129"
                 (pointerleave)="hovered_card=null"
                 (cdkDragStarted)="hovered_card=null; selectCard(user.deck.cards[0], user.deck.cards);"
                 cdkDrag loading="lazy">
          </mat-card>
        </div>
        <div class="zone-hider-outer">
          <div class="zone-hider-inner">
            <div [ngClass]="{'zone-container': !hidden, 'zone-container-hidden': hidden}">
              <div class="zone-holder">
                <button [style.display]="'none'" mat-mini-fab class="zone-toggle-button"
                (click)="hidden=!hidden"><mat-icon
                  [ngClass]="{'zones-arrow-on': !hidden, 'zones-arrow-off': hidden}">keyboard_arrow_right</mat-icon></button>
                <div class="user-grave">
                  <mat-card class="zone-data" (dblclick)="sendSelectedToSpot(user.grave, 'grave')"
                            (contextmenu)="onRightClick($event, {type: 'grave'})"
                            cdkDropList [cdkDropListData]="user.grave"
                            cdkDropListOrientation="horizontal"
                            (cdkDropListDropped)="moveCardToZone($event, 'grave')">
                    <div class="zone-title"><h5>Graveyard</h5></div>
                    <h1 class="zone-count">{{user.grave.length}}</h1>
                    <div *ngIf="user.grave.length == 0" class="mtg-card-user"></div>
                    <img *ngIf="user.grave.length > 0" class="mtg-card-user" src="{{user.grave[0].image}}"
                         (pointerleave)="hovered_card=null"
                         (cdkDragStarted)="hovered_card=null; selectCard(user.grave[0], user.grave);"
                         cdkDrag loading="lazy">
                  </mat-card>
                </div>
                <div class="user-exile">
                  <mat-card class="zone-data" (dblclick)="sendSelectedToSpot(user.exile, 'exile')"
                            (contextmenu)="onRightClick($event, {type: 'exile'})"
                            cdkDropList [cdkDropListData]="user.exile"
                            cdkDropListOrientation="horizontal"
                            (cdkDropListDropped)="moveCardToZone($event, 'exile')">
                    <div class="zone-title"><h5>Exile</h5></div>
                    <h1 class="zone-count">{{user.exile.length}}</h1>
                    <div *ngIf="user.exile.length == 0" class="mtg-card-user"></div>
                    <img *ngIf="user.exile.length > 0" class="mtg-card-user" src="{{user.exile[0].image}}"
                         (pointerleave)="hovered_card=null"
                         (cdkDragStarted)="hovered_card=null; selectCard(user.exile[0], user.exile);"
                         cdkDrag loading="lazy">
                  </mat-card>
                </div>
                <div class="user-temp-zone">
                  <mat-card class="zone-data" (dblclick)="sendSelectedToSpot(user.temp_zone, 'temp_zone')"
                            (contextmenu)="onRightClick($event, {type: 'temp-zone'})"
                            cdkDropList [cdkDropListData]="user.temp_zone"
                            cdkDropListOrientation="horizontal"
                            (cdkDropListDropped)="moveCardToZone($event, 'temp_zone')">
                    <div class="zone-title"><h5>Temp</h5></div>
                    <h1 class="zone-count">{{user.temp_zone.length}}</h1>
                    <div *ngIf="user.temp_zone.length == 0" class="mtg-card-user"></div>
                    <img *ngIf="user.temp_zone.length > 0" class="mtg-card-user" src="{{user.temp_zone[0].image}}"
                         (pointerleave)="hovered_card=null"
                         (cdkDragStarted)="hovered_card=null; selectCard(user.temp_zone[0], user.temp_zone);"
                         cdkDrag loading="lazy">
                  </mat-card>
                </div>
                <div class="commander-viewer" cdkDropList
                     [cdkDropListData]="user.deck.commander"
                     (cdkDropListDropped)="moveCardToZone($event, 'command_zone')">
                  <mat-card class="commander-viewer-mat-card">
                    <button mat-fab class="commander-counter" (click)="user.command_tax_1 = user.command_tax_1 + 1" (contextmenu)="onRightClick($event, {type: 'command_tax_1'})">
                      {{user.command_tax_1}}
                    </button>
                    <button *ngIf="user.deck.commander_saved.length == 2" mat-fab color="primary" class="commander-counter-2" (click)="user.command_tax_2 = user.command_tax_2 + 1" (contextmenu)="onRightClick($event, {type: 'command_tax_2'})">
                      {{user.command_tax_2}}
                    </button>
                    <div *ngIf="user.deck.commander_saved.length == 1">
                      <img class="commander-viewer-single" src="{{user.deck.commander_saved[0].image}}" loading="lazy"
                           (contextmenu)="onRightClick($event, {type: 'commander', card: user.deck.commander_saved[0]});
                                    selectCard(user.deck.commander_saved[0], user.deck.commander, true);"
                           (pointerenter)="hovered_card=user.deck.commander_saved[0]" (pointerleave)="hovered_card=null">
                    </div>
                    <div *ngIf="user.deck.commander_saved.length == 2" class="commander-viewer-partner-holder">
                      <img (pointerenter)="hovered_card=user.deck.commander_saved[0]" (pointerleave)="hovered_card=null" class="commander-viewer-partner-1" src="{{user.deck.commander_saved[0].image}}" loading="lazy" (contextmenu)="onRightClick($event, {type: 'commander', card: user.deck.commander_saved[0]}); selectCard(user.deck.commander_saved[0], user.deck.commander, true);">
                      <img (pointerenter)="hovered_card=user.deck.commander_saved[1]" (pointerleave)="hovered_card=null" class="commander-viewer-partner-2" src="{{user.deck.commander_saved[1].image}}" loading="lazy" (contextmenu)="onRightClick($event, {type: 'commander', card: user.deck.commander_saved[1]}); selectCard(user.deck.commander_saved[1], user.deck.commander, true);">
                    </div>
                  </mat-card>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </mat-sidenav-content>
</mat-sidenav-container>


